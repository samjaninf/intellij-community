// Copyright 2000-2021 JetBrains s.r.o. Use of this source code is governed by the Apache 2.0 license that can be found in the LICENSE file.
package com.intellij.sh.backend.shellcheck;

import com.intellij.codeInspection.ui.MultipleCheckboxOptionsPanel;
import com.intellij.codeInspection.ui.OptionAccessor;
import com.intellij.icons.AllIcons;
import com.intellij.openapi.fileChooser.FileChooserDescriptorFactory;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.ui.TextFieldWithBrowseButton;
import com.intellij.openapi.util.NlsSafe;
import com.intellij.sh.ShBundle;
import com.intellij.sh.settings.ShSettings;
import com.intellij.sh.shellcheck.ShShellcheckUtil;
import com.intellij.sh.utils.ProjectUtil;
import com.intellij.ui.DocumentAdapter;
import com.intellij.ui.EditorNotifications;
import com.intellij.ui.JBColor;
import com.intellij.ui.components.ActionLink;
import com.intellij.ui.components.JBLabel;
import com.intellij.ui.components.JBScrollPane;
import com.intellij.uiDesigner.core.GridConstraints;
import com.intellij.uiDesigner.core.GridLayoutManager;
import org.jetbrains.annotations.ApiStatus;
import org.jetbrains.annotations.Nls;
import org.jetbrains.annotations.NotNull;

import javax.swing.AbstractButton;
import javax.swing.BorderFactory;
import javax.swing.JComponent;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.border.TitledBorder;
import javax.swing.event.DocumentEvent;
import java.awt.FlowLayout;
import java.awt.Insets;
import java.lang.reflect.Method;
import java.util.ResourceBundle;
import java.util.Set;
import java.util.function.BiConsumer;

public class ShellcheckOptionsPanel {
  private final JPanel myPanel;
  private final JPanel myWarningPanel;
  private final JLabel myWarningLabel;
  private final JLabel myErrorLabel;
  @SuppressWarnings("unused")
  private final ActionLink myShellcheckDownloadLink;
  private final TextFieldWithBrowseButton myShellcheckSelector;
  private final MultipleCheckboxOptionsPanel myInspectionsCheckboxPanel;
  private final BiConsumer<String, Boolean> myInspectionsChangeListener;
  private final Set<String> myDisabledInspections;
  private final Project myProject;

  @ApiStatus.Internal
  public ShellcheckOptionsPanel(Set<String> disabledInspections, BiConsumer<String, Boolean> inspectionsChangeListener) {
    myInspectionsChangeListener = inspectionsChangeListener;
    myDisabledInspections = disabledInspections;
    {
      myShellcheckDownloadLink = new ActionLink(ShBundle.message("sh.shellcheck.download.label.text"), e -> {
        ShShellcheckUtil.download(myProject,
                                  () -> myShellcheckSelector.setText(ShSettings.getShellcheckPath(myProject)),
                                  () -> myErrorLabel.setVisible(true));
        EditorNotifications.getInstance(myProject).updateAllNotifications();
      });

      myInspectionsCheckboxPanel = new MultipleCheckboxOptionsPanel(new OptionAccessor() {
        @Override
        public boolean getOption(String optionName) {
          return myDisabledInspections.contains(optionName);
        }

        @Override
        public void setOption(String optionName, boolean optionValue) {
          myInspectionsChangeListener.accept(optionName, optionValue);
        }
      });
    }
    {
      // GUI initializer generated by IntelliJ IDEA GUI Designer
      // >>> IMPORTANT!! <<<
      // DO NOT EDIT OR ADD ANY CODE HERE!
      myPanel = new JPanel();
      myPanel.setLayout(new GridLayoutManager(4, 2, new Insets(0, 0, 0, 5), -1, -1));
      final JLabel label1 = new JLabel();
      this.$$$loadLabelText$$$(label1, this.$$$getMessageFromBundle$$$("messages/ShBundle", "sh.path.label"));
      label1.setVerticalAlignment(0);
      label1.setVerticalTextPosition(0);
      myPanel.add(label1,
                  new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                      GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myShellcheckSelector = new TextFieldWithBrowseButton();
      myPanel.add(myShellcheckSelector, new GridConstraints(0, 1, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                                            GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                            GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                            null, null, null, 0, false));
      myWarningPanel = new JPanel();
      myWarningPanel.setLayout(new FlowLayout(FlowLayout.CENTER, 0, 0));
      myWarningPanel.setEnabled(true);
      myWarningPanel.setVisible(false);
      myPanel.add(myWarningPanel, new GridConstraints(1, 0, 1, 2, GridConstraints.ANCHOR_NORTHWEST, GridConstraints.FILL_NONE,
                                                      GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                      GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null,
                                                      null, null, 0, false));
      myWarningLabel = new JLabel();
      this.$$$loadLabelText$$$(myWarningLabel, this.$$$getMessageFromBundle$$$("messages/ShBundle", "sh.invalid.path"));
      myWarningPanel.add(myWarningLabel);
      this.$$$loadButtonText$$$(myShellcheckDownloadLink, this.$$$getMessageFromBundle$$$("messages/ShBundle", "sh.download"));
      myWarningPanel.add(myShellcheckDownloadLink);
      final JLabel label2 = new JLabel();
      this.$$$loadLabelText$$$(label2, this.$$$getMessageFromBundle$$$("messages/ShBundle", "sh.shellcheck.missing"));
      myWarningPanel.add(label2);
      final JBScrollPane jBScrollPane1 = new JBScrollPane();
      myPanel.add(jBScrollPane1, new GridConstraints(3, 0, 1, 2, GridConstraints.ANCHOR_NORTH, GridConstraints.FILL_HORIZONTAL,
                                                     GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                     GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null,
                                                     null, null, 0, false));
      jBScrollPane1.setBorder(BorderFactory.createTitledBorder(BorderFactory.createEmptyBorder(), null, TitledBorder.DEFAULT_JUSTIFICATION,
                                                               TitledBorder.DEFAULT_POSITION, null, null));
      final JPanel panel1 = new JPanel();
      panel1.setLayout(new GridLayoutManager(1, 1, new Insets(0, 0, 0, 0), -1, -1));
      jBScrollPane1.setViewportView(panel1);
      panel1.add(myInspectionsCheckboxPanel, new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_BOTH,
                                                                 GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                 GridConstraints.SIZEPOLICY_CAN_GROW,
                                                                 GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                 GridConstraints.SIZEPOLICY_CAN_GROW, null, null, null, 0, false));
      myErrorLabel = new JBLabel();
      this.$$$loadLabelText$$$(myErrorLabel, this.$$$getMessageFromBundle$$$("messages/ShBundle", "sh.shellcheck.cannot.download"));
      myErrorLabel.setVisible(false);
      myPanel.add(myErrorLabel, new GridConstraints(2, 0, 1, 2, GridConstraints.ANCHOR_NORTHWEST, GridConstraints.FILL_NONE,
                                                    GridConstraints.SIZEPOLICY_FIXED, GridConstraints.SIZEPOLICY_FIXED, null, null, null, 1,
                                                    false));
    }
    myProject = ProjectUtil.getProject(getPanel());

    myShellcheckSelector.addBrowseFolderListener(myProject, FileChooserDescriptorFactory.createSingleFileDescriptor()
      .withTitle(ShBundle.message("sh.shellcheck.path.label")));
    myShellcheckSelector.getTextField().getDocument().addDocumentListener(new DocumentAdapter() {
      @Override
      protected void textChanged(@NotNull DocumentEvent documentEvent) {
        String shellcheckPath = myShellcheckSelector.getText();
        ShSettings.setShellcheckPath(myProject, shellcheckPath);
        myWarningPanel.setVisible(!ShShellcheckUtil.isValidPath(shellcheckPath));
        myErrorLabel.setVisible(false);
      }
    });

    String shellcheckPath = ShSettings.getShellcheckPath(myProject);
    myShellcheckSelector.setText(shellcheckPath);
    myWarningPanel.setVisible(!ShShellcheckUtil.isValidPath(shellcheckPath));
    myErrorLabel.setForeground(JBColor.RED);

    ShShellcheckUtil.SHELLCHECK_CODES.forEach(
      (@NlsSafe String key, @Nls String value) -> myInspectionsCheckboxPanel.addCheckbox(key + " " + value, key));
    myWarningLabel.setIcon(AllIcons.General.Warning);
  }

  private static Method $$$cachedGetBundleMethod$$$ = null;

  /** @noinspection ALL */
  private String $$$getMessageFromBundle$$$(String path, String key) {
    ResourceBundle bundle;
    try {
      Class<?> thisClass = this.getClass();
      if ($$$cachedGetBundleMethod$$$ == null) {
        Class<?> dynamicBundleClass = thisClass.getClassLoader().loadClass("com.intellij.DynamicBundle");
        $$$cachedGetBundleMethod$$$ = dynamicBundleClass.getMethod("getBundle", String.class, Class.class);
      }
      bundle = (ResourceBundle)$$$cachedGetBundleMethod$$$.invoke(null, path, thisClass);
    }
    catch (Exception e) {
      bundle = ResourceBundle.getBundle(path);
    }
    return bundle.getString(key);
  }

  /** @noinspection ALL */
  private void $$$loadLabelText$$$(JLabel component, String text) {
    StringBuffer result = new StringBuffer();
    boolean haveMnemonic = false;
    char mnemonic = '\0';
    int mnemonicIndex = -1;
    for (int i = 0; i < text.length(); i++) {
      if (text.charAt(i) == '&') {
        i++;
        if (i == text.length()) break;
        if (!haveMnemonic && text.charAt(i) != '&') {
          haveMnemonic = true;
          mnemonic = text.charAt(i);
          mnemonicIndex = result.length();
        }
      }
      result.append(text.charAt(i));
    }
    component.setText(result.toString());
    if (haveMnemonic) {
      component.setDisplayedMnemonic(mnemonic);
      component.setDisplayedMnemonicIndex(mnemonicIndex);
    }
  }

  /** @noinspection ALL */
  private void $$$loadButtonText$$$(AbstractButton component, String text) {
    StringBuffer result = new StringBuffer();
    boolean haveMnemonic = false;
    char mnemonic = '\0';
    int mnemonicIndex = -1;
    for (int i = 0; i < text.length(); i++) {
      if (text.charAt(i) == '&') {
        i++;
        if (i == text.length()) break;
        if (!haveMnemonic && text.charAt(i) != '&') {
          haveMnemonic = true;
          mnemonic = text.charAt(i);
          mnemonicIndex = result.length();
        }
      }
      result.append(text.charAt(i));
    }
    component.setText(result.toString());
    if (haveMnemonic) {
      component.setMnemonic(mnemonic);
      component.setDisplayedMnemonicIndex(mnemonicIndex);
    }
  }

  /** @noinspection ALL */
  public JComponent $$$getRootComponent$$$() { return myPanel; }

  @ApiStatus.Internal
  public JComponent getPanel() {
    return myPanel;
  }
}
