// Copyright 2000-2018 JetBrains s.r.o. Use of this source code is governed by the Apache 2.0 license that can be found in the LICENSE file.
package org.jetbrains.idea.maven.project;

import com.intellij.openapi.Disposable;
import com.intellij.openapi.externalSystem.service.ui.ExternalSystemJdkComboBox;
import com.intellij.openapi.project.ExternalStorageConfigurationManager;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.projectRoots.JavaSdkVersion;
import com.intellij.openapi.projectRoots.JavaSdkVersionUtil;
import com.intellij.openapi.ui.ComponentValidator;
import com.intellij.openapi.ui.ValidationInfo;
import com.intellij.openapi.updateSettings.impl.LabelTextReplacingUtil;
import com.intellij.openapi.util.registry.Registry;
import com.intellij.ui.EnumComboBoxModel;
import com.intellij.ui.components.JBCheckBox;
import com.intellij.ui.components.JBLabel;
import com.intellij.ui.components.JBTextField;
import com.intellij.ui.dsl.listCellRenderer.BuilderKt;
import com.intellij.uiDesigner.core.GridConstraints;
import com.intellij.uiDesigner.core.GridLayoutManager;
import com.intellij.uiDesigner.core.Spacer;
import com.intellij.util.ui.UIUtil;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;
import org.jetbrains.idea.maven.project.actions.LookForNestedToggleAction;
import org.jetbrains.idea.maven.utils.MavenUtil;

import javax.swing.AbstractButton;
import javax.swing.DefaultComboBoxModel;
import javax.swing.JCheckBox;
import javax.swing.JComboBox;
import javax.swing.JComponent;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JTextField;
import java.awt.Dimension;
import java.awt.Insets;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.lang.reflect.Method;
import java.util.ResourceBundle;

public class MavenImportingSettingsForm {
  private final JPanel myPanel;

  private final JCheckBox mySearchRecursivelyCheckBox;

  private final JComboBox<String> myUpdateFoldersOnImportPhaseComboBox;
  private final JCheckBox myUseMavenOutputCheckBox;
  private final JCheckBox myDownloadSourcesCheckBox;
  private final JCheckBox myDownloadDocsCheckBox;
  private final JCheckBox myDownloadAnnotationsCheckBox;

  private final JPanel myAdditionalSettingsPanel;
  private final JComboBox<MavenImportingSettings.GeneratedSourcesFolder> myGeneratedSourcesComboBox;
  private final JCheckBox myExcludeTargetFolderCheckBox;
  private final JTextField myDependencyTypes;
  private final JBTextField myVMOptionsForImporter;
  private final ExternalSystemJdkComboBox myJdkForImporterComboBox;
  private final JBLabel myImporterJdkWarning;
  private final JCheckBox myAutoDetectCompilerCheckBox;
  private final JCheckBox runPluginsCompat;

  private final ComponentValidator myImporterJdkValidator;
  private volatile boolean myMuteJdkValidation = false;

  public MavenImportingSettingsForm(Project project, @NotNull Disposable disposable) {
    {
      // GUI initializer generated by IntelliJ IDEA GUI Designer
      // >>> IMPORTANT!! <<<
      // DO NOT EDIT OR ADD ANY CODE HERE!
      myPanel = new JPanel();
      myPanel.setLayout(new GridLayoutManager(22, 4, new Insets(0, 0, 0, 0), -1, -1));
      mySearchRecursivelyCheckBox = new JCheckBox();
      this.$$$loadButtonText$$$(mySearchRecursivelyCheckBox, this.$$$getMessageFromBundle$$$("messages/MavenConfigurableBundle",
                                                                                             "maven.settings.importing.search.recursively"));
      myPanel.add(mySearchRecursivelyCheckBox, new GridConstraints(0, 0, 1, 3, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                                   GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                   GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED,
                                                                   null, null, null, 0, false));
      myUseMavenOutputCheckBox = new JCheckBox();
      this.$$$loadButtonText$$$(myUseMavenOutputCheckBox, this.$$$getMessageFromBundle$$$("messages/MavenConfigurableBundle",
                                                                                          "maven.settings.importing.use.output.directories"));
      myUseMavenOutputCheckBox.setToolTipText(
        this.$$$getMessageFromBundle$$$("messages/MavenConfigurableBundle", "maven.settings.importing.use.output.directories.tooltip"));
      myPanel.add(myUseMavenOutputCheckBox, new GridConstraints(4, 0, 1, 3, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                                GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                                GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      final JBLabel jBLabel1 = new JBLabel();
      jBLabel1.setComponentStyle(UIUtil.ComponentStyle.SMALL);
      jBLabel1.setFontColor(UIUtil.FontColor.BRIGHTER);
      this.$$$loadLabelText$$$(jBLabel1, this.$$$getMessageFromBundle$$$("messages/MavenConfigurableBundle",
                                                                         "maven.settings.importing.phase.for.source.updates.notes"));
      myPanel.add(jBLabel1, new GridConstraints(9, 0, 1, 3, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                                GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                GridConstraints.SIZEPOLICY_FIXED, null, null, null, 3, false));
      final JPanel panel1 = new JPanel();
      panel1.setLayout(new GridLayoutManager(1, 5, new Insets(10, 0, 0, 0), -1, -1));
      panel1.setFocusable(true);
      myPanel.add(panel1, new GridConstraints(11, 0, 1, 3, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_BOTH,
                                              GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                              GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null, null, null,
                                              0, false));
      final JLabel label1 = new JLabel();
      this.$$$loadLabelText$$$(label1, this.$$$getMessageFromBundle$$$("messages/MavenConfigurableBundle",
                                                                       "maven.settings.importing.auto.download"));
      panel1.add(label1,
                 new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                     GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myDownloadSourcesCheckBox = new JCheckBox();
      this.$$$loadButtonText$$$(myDownloadSourcesCheckBox, this.$$$getMessageFromBundle$$$("messages/MavenConfigurableBundle",
                                                                                           "maven.settings.importing.auto.download.sources"));
      panel1.add(myDownloadSourcesCheckBox, new GridConstraints(0, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                                GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                                GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myDownloadDocsCheckBox = new JCheckBox();
      this.$$$loadButtonText$$$(myDownloadDocsCheckBox, this.$$$getMessageFromBundle$$$("messages/MavenConfigurableBundle",
                                                                                        "maven.settings.importing.auto.download.documentation"));
      panel1.add(myDownloadDocsCheckBox, new GridConstraints(0, 2, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                             GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                             GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      final Spacer spacer1 = new Spacer();
      panel1.add(spacer1, new GridConstraints(0, 4, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                              GridConstraints.SIZEPOLICY_WANT_GROW, 1, null, null, null, 0, false));
      myDownloadAnnotationsCheckBox = new JBCheckBox();
      this.$$$loadButtonText$$$(myDownloadAnnotationsCheckBox, this.$$$getMessageFromBundle$$$("messages/MavenConfigurableBundle",
                                                                                               "maven.settings.importing.auto.download.annotations"));
      panel1.add(myDownloadAnnotationsCheckBox,
                 new GridConstraints(0, 3, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                     GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myAdditionalSettingsPanel = new JPanel();
      myAdditionalSettingsPanel.setLayout(new GridLayoutManager(1, 1, new Insets(15, 0, 0, 0), -1, -1));
      myPanel.add(myAdditionalSettingsPanel, new GridConstraints(20, 0, 1, 3, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_VERTICAL,
                                                                 GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                 GridConstraints.SIZEPOLICY_CAN_GROW,
                                                                 GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                 GridConstraints.SIZEPOLICY_CAN_GROW, null, null, null, 0, false));
      final Spacer spacer2 = new Spacer();
      myPanel.add(spacer2, new GridConstraints(11, 3, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                               GridConstraints.SIZEPOLICY_WANT_GROW, 1, null, null, null, 0, false));
      final Spacer spacer3 = new Spacer();
      myPanel.add(spacer3, new GridConstraints(21, 0, 1, 3, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_VERTICAL, 1,
                                               GridConstraints.SIZEPOLICY_WANT_GROW, null, null, null, 0, false));
      final JPanel panel2 = new JPanel();
      panel2.setLayout(new GridLayoutManager(1, 3, new Insets(0, 0, 0, 0), -1, -1));
      myPanel.add(panel2, new GridConstraints(8, 0, 1, 3, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_BOTH,
                                              GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                              GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null, null, null,
                                              0, false));
      myUpdateFoldersOnImportPhaseComboBox = new JComboBox();
      panel2.add(myUpdateFoldersOnImportPhaseComboBox,
                 new GridConstraints(0, 1, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                     GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      final JLabel label2 = new JLabel();
      this.$$$loadLabelText$$$(label2, this.$$$getMessageFromBundle$$$("messages/MavenConfigurableBundle",
                                                                       "maven.settings.importing.phase.for.source.updates"));
      panel2.add(label2,
                 new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                     GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      final Spacer spacer4 = new Spacer();
      panel2.add(spacer4, new GridConstraints(0, 2, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                              GridConstraints.SIZEPOLICY_WANT_GROW, 1, null, null, null, 0, false));
      final Spacer spacer5 = new Spacer();
      myPanel.add(spacer5, new GridConstraints(7, 0, 1, 3, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_VERTICAL, 1,
                                               GridConstraints.SIZEPOLICY_FIXED, null, new Dimension(-1, 10), null, 0, false));
      final Spacer spacer6 = new Spacer();
      myPanel.add(spacer6, new GridConstraints(1, 0, 1, 3, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_VERTICAL, 1,
                                               GridConstraints.SIZEPOLICY_FIXED, null, new Dimension(-1, 10), null, 0, false));
      final JPanel panel3 = new JPanel();
      panel3.setLayout(new GridLayoutManager(1, 3, new Insets(0, 0, 0, 0), -1, -1));
      myPanel.add(panel3, new GridConstraints(6, 0, 1, 3, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_BOTH,
                                              GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                              GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null, null, null,
                                              0, false));
      final JLabel label3 = new JLabel();
      this.$$$loadLabelText$$$(label3, this.$$$getMessageFromBundle$$$("messages/MavenConfigurableBundle",
                                                                       "maven.settings.importing.generated.source.folders"));
      panel3.add(label3,
                 new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                     GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      final Spacer spacer7 = new Spacer();
      panel3.add(spacer7, new GridConstraints(0, 2, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                              GridConstraints.SIZEPOLICY_WANT_GROW, 1, null, null, null, 0, false));
      myGeneratedSourcesComboBox = new JComboBox();
      panel3.add(myGeneratedSourcesComboBox, new GridConstraints(0, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_HORIZONTAL,
                                                                 GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED,
                                                                 null, null, null, 0, false));
      myExcludeTargetFolderCheckBox = new JCheckBox();
      this.$$$loadButtonText$$$(myExcludeTargetFolderCheckBox, this.$$$getMessageFromBundle$$$("messages/MavenConfigurableBundle",
                                                                                               "maven.settings.importing.project.exclude.build.directory"));
      myExcludeTargetFolderCheckBox.setToolTipText(this.$$$getMessageFromBundle$$$("messages/MavenConfigurableBundle",
                                                                                   "maven.settings.importing.project.exclude.build.directory.tooltip"));
      myPanel.add(myExcludeTargetFolderCheckBox, new GridConstraints(3, 0, 1, 3, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                                     GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                     GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED,
                                                                     null, null, null, 0, false));
      final JLabel label4 = new JLabel();
      this.$$$loadLabelText$$$(label4, this.$$$getMessageFromBundle$$$("messages/MavenConfigurableBundle",
                                                                       "maven.settings.importing.dependency.type"));
      label4.setToolTipText(
        this.$$$getMessageFromBundle$$$("messages/MavenConfigurableBundle", "maven.settings.importing.dependency.type.tooltip"));
      myPanel.add(label4,
                  new GridConstraints(12, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                      GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myDependencyTypes = new JTextField();
      myDependencyTypes.setColumns(0);
      myDependencyTypes.setToolTipText(
        this.$$$getMessageFromBundle$$$("messages/MavenConfigurableBundle", "maven.settings.importing.dependency.type.tooltip"));
      myPanel.add(myDependencyTypes, new GridConstraints(12, 1, 1, 2, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_HORIZONTAL,
                                                         GridConstraints.SIZEPOLICY_WANT_GROW, GridConstraints.SIZEPOLICY_FIXED, null,
                                                         new Dimension(60, -1), null, 0, false));
      final JBLabel jBLabel2 = new JBLabel();
      jBLabel2.setComponentStyle(UIUtil.ComponentStyle.SMALL);
      jBLabel2.setFontColor(UIUtil.FontColor.BRIGHTER);
      jBLabel2.setHorizontalTextPosition(4);
      this.$$$loadLabelText$$$(jBLabel2, this.$$$getMessageFromBundle$$$("messages/MavenConfigurableBundle",
                                                                         "maven.settings.importing.dependency.type.tooltip"));
      myPanel.add(jBLabel2, new GridConstraints(13, 1, 1, 2, GridConstraints.ANCHOR_NORTHWEST, GridConstraints.FILL_NONE,
                                                GridConstraints.SIZEPOLICY_FIXED, GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0,
                                                false));
      final Spacer spacer8 = new Spacer();
      myPanel.add(spacer8, new GridConstraints(14, 0, 1, 3, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_VERTICAL, 1,
                                               GridConstraints.SIZEPOLICY_FIXED, null, new Dimension(-1, 10), null, 0, false));
      final Spacer spacer9 = new Spacer();
      myPanel.add(spacer9, new GridConstraints(10, 0, 1, 3, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_VERTICAL, 1,
                                               GridConstraints.SIZEPOLICY_FIXED, null, new Dimension(-1, 10), null, 0, false));
      final JBLabel jBLabel3 = new JBLabel();
      this.$$$loadLabelText$$$(jBLabel3,
                               this.$$$getMessageFromBundle$$$("messages/MavenConfigurableBundle", "maven.settings.importing.vm.options"));
      myPanel.add(jBLabel3,
                  new GridConstraints(15, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                      GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myVMOptionsForImporter = new JBTextField();
      myPanel.add(myVMOptionsForImporter, new GridConstraints(15, 1, 1, 2, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                                              GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                              GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                              null, null, null, 0, false));
      final JBLabel jBLabel4 = new JBLabel();
      this.$$$loadLabelText$$$(jBLabel4,
                               this.$$$getMessageFromBundle$$$("messages/MavenConfigurableBundle", "maven.settings.importing.jdk"));
      myPanel.add(jBLabel4,
                  new GridConstraints(17, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                      GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myJdkForImporterComboBox = new ExternalSystemJdkComboBox();
      final DefaultComboBoxModel defaultComboBoxModel1 = new DefaultComboBoxModel();
      myJdkForImporterComboBox.setModel(defaultComboBoxModel1);
      myPanel.add(myJdkForImporterComboBox, new GridConstraints(17, 1, 1, 2, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                                                GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_CAN_GROW,
                                                                null, null, null, 0, false));
      myAutoDetectCompilerCheckBox = new JCheckBox();
      myAutoDetectCompilerCheckBox.setSelected(true);
      this.$$$loadButtonText$$$(myAutoDetectCompilerCheckBox, this.$$$getMessageFromBundle$$$("messages/MavenConfigurableBundle",
                                                                                              "maven.settings.importing.detect.compiler"));
      myPanel.add(myAutoDetectCompilerCheckBox, new GridConstraints(2, 0, 1, 3, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                                    GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                    GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED,
                                                                    null, null, null, 0, false));
      final JBLabel jBLabel5 = new JBLabel();
      jBLabel5.setComponentStyle(UIUtil.ComponentStyle.SMALL);
      jBLabel5.setFontColor(UIUtil.FontColor.BRIGHTER);
      jBLabel5.setHorizontalTextPosition(4);
      this.$$$loadLabelText$$$(jBLabel5,
                               this.$$$getMessageFromBundle$$$("messages/MavenConfigurableBundle", "maven.settings.vm.options.tooltip"));
      myPanel.add(jBLabel5, new GridConstraints(16, 1, 1, 2, GridConstraints.ANCHOR_NORTHWEST, GridConstraints.FILL_NONE,
                                                GridConstraints.SIZEPOLICY_FIXED, GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0,
                                                false));
      myImporterJdkWarning = new JBLabel();
      myImporterJdkWarning.setComponentStyle(UIUtil.ComponentStyle.SMALL);
      myImporterJdkWarning.setFontColor(UIUtil.FontColor.BRIGHTER);
      this.$$$loadLabelText$$$(myImporterJdkWarning, this.$$$getMessageFromBundle$$$("messages/MavenConfigurableBundle",
                                                                                     "maven.settings.importing.jdk.fallback.warning"));
      myPanel.add(myImporterJdkWarning, new GridConstraints(19, 1, 1, 1, GridConstraints.ANCHOR_NORTHWEST, GridConstraints.FILL_NONE,
                                                            GridConstraints.SIZEPOLICY_FIXED, GridConstraints.SIZEPOLICY_FIXED, null, null,
                                                            null, 0, false));
      runPluginsCompat = new JCheckBox();
      this.$$$loadButtonText$$$(runPluginsCompat, this.$$$getMessageFromBundle$$$("messages/MavenConfigurableBundle",
                                                                                  "maven.settings.importing.use.plugin.compat"));
      runPluginsCompat.setToolTipText(
        this.$$$getMessageFromBundle$$$("messages/MavenConfigurableBundle", "maven.settings.importing.use.plugin.compat.tooltip"));
      myPanel.add(runPluginsCompat, new GridConstraints(5, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                        GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                        GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      label2.setLabelFor(myUpdateFoldersOnImportPhaseComboBox);
      label4.setLabelFor(myDependencyTypes);
      jBLabel2.setLabelFor(myDependencyTypes);
      jBLabel5.setLabelFor(myDependencyTypes);
    }
    myJdkForImporterComboBox.setProject(project);
    mySearchRecursivelyCheckBox.setVisible(project.isDefault());

    myUpdateFoldersOnImportPhaseComboBox.setModel(new DefaultComboBoxModel<>(MavenImportingSettings.UPDATE_FOLDERS_PHASES));

    myGeneratedSourcesComboBox.setModel(new EnumComboBoxModel<>(MavenImportingSettings.GeneratedSourcesFolder.class));
    myGeneratedSourcesComboBox.setRenderer(BuilderKt.textListCellRenderer("", value -> value.getTitle()));

    LabelTextReplacingUtil.replaceText(myPanel);
    myAutoDetectCompilerCheckBox.setVisible(Registry.is("maven.import.compiler.arguments", true));
    runPluginsCompat.setVisible(Registry.is("maven.use.plugins.m2e.compat"));
    myJdkForImporterComboBox.setHighlightInternalJdk(false);
    ActionListener validatorListener = new ActionListener() {
      @Override
      public void actionPerformed(ActionEvent e) {
        validateImporterJDK();
      }
    };
    myJdkForImporterComboBox.addActionListener(validatorListener);

    myImporterJdkValidator = new ComponentValidator(disposable)
      .withValidator(() -> {
        if (JavaSdkVersionUtil.isAtLeast(myJdkForImporterComboBox.getSelectedJdk(), JavaSdkVersion.JDK_17)) {
          return null;
        }
        var settings = MavenWorkspaceSettingsComponent.getInstance(project).getSettings();
        MavenHomeType type = settings.getGeneralSettings().getMavenHomeType();
        if (type instanceof StaticResolvedMavenHomeType staticResolvedMavenHomeType) {
          var version = MavenUtil.getMavenVersion(staticResolvedMavenHomeType);
          if (version != null && version.startsWith("4")) {
            return new ValidationInfo(MavenConfigurableBundle.message("maven.settings.importing.jdk.too.old.error.4"),
                                      myJdkForImporterComboBox);
          }
        }
        if (!JavaSdkVersionUtil.isAtLeast(myJdkForImporterComboBox.getSelectedJdk(), JavaSdkVersion.JDK_1_8)) {
          return new ValidationInfo(MavenConfigurableBundle.message("maven.settings.importing.jdk.too.old.error"),
                                    myJdkForImporterComboBox);
        }
        return null;
      })
      .installOn(myJdkForImporterComboBox);

    myImporterJdkWarning.setVisible(false);
  }

  private static Method $$$cachedGetBundleMethod$$$ = null;

  /** @noinspection ALL */
  private String $$$getMessageFromBundle$$$(String path, String key) {
    ResourceBundle bundle;
    try {
      Class<?> thisClass = this.getClass();
      if ($$$cachedGetBundleMethod$$$ == null) {
        Class<?> dynamicBundleClass = thisClass.getClassLoader().loadClass("com.intellij.DynamicBundle");
        $$$cachedGetBundleMethod$$$ = dynamicBundleClass.getMethod("getBundle", String.class, Class.class);
      }
      bundle = (ResourceBundle)$$$cachedGetBundleMethod$$$.invoke(null, path, thisClass);
    }
    catch (Exception e) {
      bundle = ResourceBundle.getBundle(path);
    }
    return bundle.getString(key);
  }

  /** @noinspection ALL */
  private void $$$loadLabelText$$$(JLabel component, String text) {
    StringBuffer result = new StringBuffer();
    boolean haveMnemonic = false;
    char mnemonic = '\0';
    int mnemonicIndex = -1;
    for (int i = 0; i < text.length(); i++) {
      if (text.charAt(i) == '&') {
        i++;
        if (i == text.length()) break;
        if (!haveMnemonic && text.charAt(i) != '&') {
          haveMnemonic = true;
          mnemonic = text.charAt(i);
          mnemonicIndex = result.length();
        }
      }
      result.append(text.charAt(i));
    }
    component.setText(result.toString());
    if (haveMnemonic) {
      component.setDisplayedMnemonic(mnemonic);
      component.setDisplayedMnemonicIndex(mnemonicIndex);
    }
  }

  /** @noinspection ALL */
  private void $$$loadButtonText$$$(AbstractButton component, String text) {
    StringBuffer result = new StringBuffer();
    boolean haveMnemonic = false;
    char mnemonic = '\0';
    int mnemonicIndex = -1;
    for (int i = 0; i < text.length(); i++) {
      if (text.charAt(i) == '&') {
        i++;
        if (i == text.length()) break;
        if (!haveMnemonic && text.charAt(i) != '&') {
          haveMnemonic = true;
          mnemonic = text.charAt(i);
          mnemonicIndex = result.length();
        }
      }
      result.append(text.charAt(i));
    }
    component.setText(result.toString());
    if (haveMnemonic) {
      component.setMnemonic(mnemonic);
      component.setDisplayedMnemonicIndex(mnemonicIndex);
    }
  }

  /** @noinspection ALL */
  public JComponent $$$getRootComponent$$$() { return myPanel; }

  private void updateModuleDirControls() {
    validateImporterJDK();
  }

  public String getDefaultModuleDir() {
    return "";
  }

  public JComponent createComponent() {
    return myPanel;
  }

  public void getData(@NotNull MavenImportingSettings data) {
    data.setLookForNested(mySearchRecursivelyCheckBox.isSelected());
    LookForNestedToggleAction.setSelected(mySearchRecursivelyCheckBox.isSelected());

    data.setExcludeTargetFolder(myExcludeTargetFolderCheckBox.isSelected());
    data.setUseMavenOutput(myUseMavenOutputCheckBox.isSelected());

    data.setUpdateFoldersOnImportPhase((String)myUpdateFoldersOnImportPhaseComboBox.getSelectedItem());
    data.setGeneratedSourcesFolder((MavenImportingSettings.GeneratedSourcesFolder)myGeneratedSourcesComboBox.getSelectedItem());

    data.setDownloadSourcesAutomatically(myDownloadSourcesCheckBox.isSelected());
    data.setDownloadDocsAutomatically(myDownloadDocsCheckBox.isSelected());
    data.setDownloadAnnotationsAutomatically(myDownloadAnnotationsCheckBox.isSelected());
    data.setAutoDetectCompiler(myAutoDetectCompilerCheckBox.isSelected());
    data.setRunPluginsCompatibilityOnSyncAndBuild(runPluginsCompat.isSelected());

    data.setVmOptionsForImporter(myVMOptionsForImporter.getText());
    data.setJdkForImporter(myJdkForImporterComboBox.getSelectedValue());

    data.setDependencyTypes(myDependencyTypes.getText());
  }

  public void setData(MavenImportingSettings data, @Nullable Project project) {
    mySearchRecursivelyCheckBox.setSelected(LookForNestedToggleAction.isSelected());

    myExcludeTargetFolderCheckBox.setSelected(data.isExcludeTargetFolder());
    myUseMavenOutputCheckBox.setSelected(data.isUseMavenOutput());

    myUpdateFoldersOnImportPhaseComboBox.setSelectedItem(data.getUpdateFoldersOnImportPhase());
    myGeneratedSourcesComboBox.setSelectedItem(data.getGeneratedSourcesFolder());

    myDownloadSourcesCheckBox.setSelected(data.isDownloadSourcesAutomatically());
    myDownloadDocsCheckBox.setSelected(data.isDownloadDocsAutomatically());
    myDownloadAnnotationsCheckBox.setSelected(data.isDownloadAnnotationsAutomatically());
    myAutoDetectCompilerCheckBox.setSelected(data.isAutoDetectCompiler());
    runPluginsCompat.setSelected(data.isRunPluginsCompatibilityOnSyncAndBuild());

    myDependencyTypes.setText(data.getDependencyTypes());

    myVMOptionsForImporter.setText(data.getVmOptionsForImporter());
    skipValidationDuring(() -> myJdkForImporterComboBox.refreshData(data.getJdkForImporter()));

    updateModuleDirControls();
  }


  private void skipValidationDuring(Runnable r) {
    myMuteJdkValidation = true;
    try {
      r.run();
    }
    finally {
      myMuteJdkValidation = false;
      validateImporterJDK();
    }
  }

  private static boolean isCurrentlyStoredExternally(@Nullable Project project) {
    return project == null || ExternalStorageConfigurationManager.getInstance(project).isEnabled();
  }

  public boolean isModified(@NotNull MavenImportingSettings settings) {
    MavenImportingSettings formData = new MavenImportingSettings();
    getData(formData);
    return !formData.equals(settings);
  }

  public JPanel getAdditionalSettingsPanel() {
    return myAdditionalSettingsPanel;
  }

  private void validateImporterJDK() {
    if (myMuteJdkValidation) {
      return;
    }
    myImporterJdkValidator.revalidate();
    if (myImporterJdkValidator.getValidationInfo() == null) {
      myImporterJdkWarning.setVisible(false);
    }
    else {
      myImporterJdkWarning.setVisible(true);
    }
  }
}
