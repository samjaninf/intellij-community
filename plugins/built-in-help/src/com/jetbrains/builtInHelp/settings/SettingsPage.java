// Copyright 2000-2019 JetBrains s.r.o. Use of this source code is governed by the Apache 2.0 license that can be found in the LICENSE file.
package com.jetbrains.builtInHelp.settings;

import com.intellij.ide.IdeBundle;
import com.intellij.ide.browsers.WebBrowser;
import com.intellij.ide.browsers.WebBrowserManager;
import com.intellij.openapi.options.Configurable;
import com.intellij.openapi.util.Pair;
import com.intellij.ui.IdeBorderFactory;
import com.intellij.uiDesigner.core.GridConstraints;
import com.intellij.uiDesigner.core.GridLayoutManager;
import com.intellij.uiDesigner.core.Spacer;
import com.jetbrains.builtInHelp.BuiltInHelpBundle;
import com.jetbrains.builtInHelp.Utils;
import org.jetbrains.annotations.NonNls;

import javax.swing.BorderFactory;
import javax.swing.JCheckBox;
import javax.swing.JComboBox;
import javax.swing.JComponent;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JTextField;
import javax.swing.border.TitledBorder;
import javax.swing.event.DocumentEvent;
import javax.swing.event.DocumentListener;
import java.awt.Dimension;
import java.awt.Insets;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.lang.reflect.Method;
import java.util.ResourceBundle;


public class SettingsPage implements Configurable {

  public static final @NonNls SettingKey OPEN_HELP_FROM_WEB = SettingKey.simple("bundled.help.open.web.site.when.possible");
  public static final @NonNls SettingKey USE_BROWSER = SettingKey.simple("bundled.help.use.specific.web.browser");
  public static final @NonNls SettingKey OPEN_HELP_BASE_URL = SettingKey.simple("bundled.help.open.web.site.base.url");

  private final SettingsPageUI ui = new SettingsPageUI();

  @Override
  public String getDisplayName() {
    return IdeBundle.message("configurable.SettingsPage.display.name");
  }

  @Override
  public JComponent createComponent() {
    ui.addListeners();

    WebBrowserManager mgr = WebBrowserManager.getInstance();
    ui.webBrowserList.addItem(BuiltInHelpBundle.message("use.default.browser"));
    for (WebBrowser browser : mgr.getBrowsers()) {
      ui.webBrowserList.addItem(browser.getName());
    }

    return ui.root;
  }

  @Override
  public boolean isModified() {
    return ui.modified;
  }

  @Override
  public void disposeUIResources() {
    ui.removeListeners();
  }

  @Override
  public void reset() {
    ui.reset();
  }

  @Override
  public void apply() {
    ui.apply();
  }

  public static class SettingKey extends Pair<String, Boolean> {

    SettingKey(String first, Boolean second) {
      super(first, second);
    }

    static SettingKey simple(String name) {
      return new SettingKey(name, false);
    }

    static SettingKey secure(String name) {
      return new SettingKey(name, true);
    }
  }

  static class SettingsPageUI {
    boolean modified = false;
    ActionListener actionListener = new ActionListener() {
      @Override
      public void actionPerformed(ActionEvent e) {
        modified = true;
      }
    };

    final JPanel root;
    final JCheckBox openWebSite;
    final JTextField baseUrl;
    final JComboBox<String> webBrowserList;

    public SettingsPageUI() {
      {
        // GUI initializer generated by IntelliJ IDEA GUI Designer
        // >>> IMPORTANT!! <<<
        // DO NOT EDIT OR ADD ANY CODE HERE!
        root = new JPanel();
        root.setLayout(new GridLayoutManager(3, 3, new Insets(0, 0, 0, 0), -1, -1));
        final JPanel panel1 = new JPanel();
        panel1.setLayout(new GridLayoutManager(5, 2, new Insets(5, 5, 5, 5), -1, -1));
        panel1.putClientProperty("BorderFactoryClass", "com.intellij.ui.IdeBorderFactory$PlainSmallWithIndent");
        root.add(panel1, new GridConstraints(1, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_BOTH,
                                             GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                             GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null, null, null,
                                             0,
                                             false));
        panel1.setBorder(IdeBorderFactory.PlainSmallWithIndent.createTitledBorder(BorderFactory.createEtchedBorder(),
                                                                                  this.$$$getMessageFromBundle$$$(
                                                                                    "messages/BuiltInHelpBundle", "settings.border.title"),
                                                                                  TitledBorder.DEFAULT_JUSTIFICATION,
                                                                                  TitledBorder.DEFAULT_POSITION, null, null));
        final JLabel label1 = new JLabel();
        this.$$$loadLabelText$$$(label1,
                                 this.$$$getMessageFromBundle$$$("messages/BuiltInHelpBundle", "try.opening.online.help.when.available"));
        panel1.add(label1,
                   new GridConstraints(1, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                       GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
        openWebSite = new JCheckBox();
        openWebSite.setText("");
        panel1.add(openWebSite, new GridConstraints(1, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                    GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                    GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
        final Spacer spacer1 = new Spacer();
        panel1.add(spacer1, new GridConstraints(2, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_VERTICAL, 1,
                                                GridConstraints.SIZEPOLICY_WANT_GROW, null, null, null, 0, false));
        final JLabel label2 = new JLabel();
        this.$$$loadLabelText$$$(label2, this.$$$getMessageFromBundle$$$("messages/BuiltInHelpBundle", "online.help.base.url"));
        panel1.add(label2,
                   new GridConstraints(3, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                       GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
        final JLabel label3 = new JLabel();
        this.$$$loadLabelText$$$(label3, this.$$$getMessageFromBundle$$$("messages/BuiltInHelpBundle", "use.this.browser"));
        panel1.add(label3,
                   new GridConstraints(4, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                       GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
        webBrowserList = new JComboBox();
        panel1.add(webBrowserList, new GridConstraints(4, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_HORIZONTAL,
                                                       GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED, null, null,
                                                       null, 0, false));
        baseUrl = new JTextField();
        panel1.add(baseUrl, new GridConstraints(3, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_HORIZONTAL,
                                                GridConstraints.SIZEPOLICY_WANT_GROW, GridConstraints.SIZEPOLICY_FIXED, null,
                                                new Dimension(150, -1), null, 0, false));
        final Spacer spacer2 = new Spacer();
        root.add(spacer2, new GridConstraints(2, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_VERTICAL, 1,
                                              GridConstraints.SIZEPOLICY_WANT_GROW, null, null, null, 0, false));
      }
    }

    private static Method $$$cachedGetBundleMethod$$$ = null;

    /** @noinspection ALL */
    private String $$$getMessageFromBundle$$$(String path, String key) {
      ResourceBundle bundle;
      try {
        Class<?> thisClass = this.getClass();
        if ($$$cachedGetBundleMethod$$$ == null) {
          Class<?> dynamicBundleClass = thisClass.getClassLoader().loadClass("com.intellij.DynamicBundle");
          $$$cachedGetBundleMethod$$$ = dynamicBundleClass.getMethod("getBundle", String.class, Class.class);
        }
        bundle = (ResourceBundle)$$$cachedGetBundleMethod$$$.invoke(null, path, thisClass);
      }
      catch (Exception e) {
        bundle = ResourceBundle.getBundle(path);
      }
      return bundle.getString(key);
    }

    /** @noinspection ALL */
    private void $$$loadLabelText$$$(JLabel component, String text) {
      StringBuffer result = new StringBuffer();
      boolean haveMnemonic = false;
      char mnemonic = '\0';
      int mnemonicIndex = -1;
      for (int i = 0; i < text.length(); i++) {
        if (text.charAt(i) == '&') {
          i++;
          if (i == text.length()) break;
          if (!haveMnemonic && text.charAt(i) != '&') {
            haveMnemonic = true;
            mnemonic = text.charAt(i);
            mnemonicIndex = result.length();
          }
        }
        result.append(text.charAt(i));
      }
      component.setText(result.toString());
      if (haveMnemonic) {
        component.setDisplayedMnemonic(mnemonic);
        component.setDisplayedMnemonicIndex(mnemonicIndex);
      }
    }

    /** @noinspection ALL */
    public JComponent $$$getRootComponent$$$() { return root; }

    DocumentListener textChangeListener = new DocumentListener() {
      @Override
      public void insertUpdate(DocumentEvent e) {
        modified = true;
      }

      @Override
      public void removeUpdate(DocumentEvent e) {
        modified = true;
      }

      @Override
      public void changedUpdate(DocumentEvent e) {
        modified = true;
      }
    };

    void addListeners() {
      openWebSite.addActionListener(actionListener);
      webBrowserList.addActionListener(actionListener);
      baseUrl.getDocument().addDocumentListener(textChangeListener);
      baseUrl.addActionListener(actionListener);
    }

    void removeListeners() {
      openWebSite.removeActionListener(actionListener);
      webBrowserList.removeActionListener(actionListener);
      baseUrl.getDocument().removeDocumentListener(textChangeListener);
    }

    void apply() {
      Utils.setStoredValue(OPEN_HELP_FROM_WEB, String.valueOf(openWebSite.isSelected()));
      Utils.setStoredValue(USE_BROWSER, String.valueOf(webBrowserList.getSelectedItem()));
      Utils.setStoredValue(OPEN_HELP_BASE_URL, baseUrl.getText());
      modified = false;
    }

    void reset() {
      final String storedSelection = Utils.getStoredValue(USE_BROWSER, BuiltInHelpBundle.message("use.default.browser"));
      int totalItems = webBrowserList.getItemCount();

      for (int i = 0; i < totalItems; i++) {
        if (webBrowserList.getItemAt(i).equals(storedSelection)) {
          webBrowserList.setSelectedIndex(i);
          break;
        }
      }

      openWebSite.setSelected(Boolean.parseBoolean(Utils.getStoredValue(OPEN_HELP_FROM_WEB, "true")));
      baseUrl.setText(Utils.getStoredValue(OPEN_HELP_BASE_URL, Utils.BASE_HELP_URL));
      modified = false;
    }
  }
}
