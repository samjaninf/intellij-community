// Copyright 2000-2022 JetBrains s.r.o. and contributors. Use of this source code is governed by the Apache 2.0 license.
package org.jetbrains.kotlin.idea.run;

import com.intellij.application.options.ModuleDescriptionsComboBox;
import com.intellij.execution.ExecutionBundle;
import com.intellij.execution.application.ClassEditorField;
import com.intellij.execution.configurations.ConfigurationUtil;
import com.intellij.execution.ui.ClassBrowser;
import com.intellij.execution.ui.CommonJavaParametersPanel;
import com.intellij.execution.ui.ConfigurationModuleSelector;
import com.intellij.execution.ui.DefaultJreSelector;
import com.intellij.execution.ui.JrePathEditor;
import com.intellij.execution.ui.ShortenCommandLineModeCombo;
import com.intellij.ide.util.ClassFilter;
import com.intellij.ide.util.TreeClassChooser;
import com.intellij.ide.util.TreeJavaClassChooserDialog;
import com.intellij.openapi.application.ReadAction;
import com.intellij.openapi.module.Module;
import com.intellij.openapi.module.ModuleType;
import com.intellij.openapi.module.ModuleTypeManager;
import com.intellij.openapi.module.ModuleUtilCore;
import com.intellij.openapi.options.SettingsEditor;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.ui.LabeledComponent;
import com.intellij.openapi.ui.LabeledComponentNoThrow;
import com.intellij.openapi.util.Computable;
import com.intellij.psi.JavaCodeFragment;
import com.intellij.psi.PsiClass;
import com.intellij.psi.util.PsiMethodUtil;
import com.intellij.ui.PanelWithAnchor;
import com.intellij.uiDesigner.core.GridConstraints;
import com.intellij.uiDesigner.core.GridLayoutManager;
import com.intellij.uiDesigner.core.Spacer;
import com.intellij.util.ui.UIUtil;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.kotlin.asJava.classes.KtLightClass;

import javax.swing.JComponent;
import javax.swing.JPanel;
import java.awt.Dimension;
import java.awt.Insets;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.lang.reflect.Method;
import java.util.ResourceBundle;

public final class KotlinRunConfigurationEditor extends SettingsEditor<KotlinRunConfiguration> implements PanelWithAnchor {
  private final JPanel mainPanel;
  private final LabeledComponent<ClassEditorField> mainClassEditorField;

  private final CommonJavaParametersPanel commonProgramParameters;
  private final LabeledComponentNoThrow<ModuleDescriptionsComboBox> moduleChooser;
  private final JrePathEditor jrePathEditor;
  private final LabeledComponent<ShortenCommandLineModeCombo> shortenClasspathModeCombo;

  private JComponent anchor;

  private final ConfigurationModuleSelector moduleSelector;

  private ClassBrowser createApplicationClassBrowser(
    Project project,
    Computable<? extends Module> moduleSelector
  ) {
    ClassFilter applicationClass =
      aClass -> aClass instanceof KtLightClass &&
                ConfigurationUtil.MAIN_CLASS.value(aClass) &&
                ReadAction.compute(() -> PsiMethodUtil.findMainMethod(aClass)) != null;
    return new ClassBrowser.MainClassBrowser<>(project, moduleSelector, ExecutionBundle.message("choose.main.class.dialog.title")) {
      @Override
      protected ClassFilter createFilter(Module module) {
        return applicationClass;
      }

      @Override
      protected void onClassChosen(@NotNull PsiClass psiClass) {
        Module module = ModuleUtilCore.findModuleForPsiElement(psiClass);
        if (module != null && ModuleTypeManager.getInstance().isClasspathProvider(ModuleType.get(module))) {
          moduleChooser.getComponent().setSelectedModule(module);
        }
      }

      @Override
      protected TreeClassChooser createClassChooser(ClassFilter.ClassFilterWithScope classFilter) {
        Project project = getProject();
        return new TreeJavaClassChooserDialog(myTitle, project, classFilter.getScope(), classFilter, null, null, true);
      }
    };
  }

  public KotlinRunConfigurationEditor(Project project) {
    {
      mainClassEditorField = new LabeledComponent<>();
      mainClassEditorField.setComponent(ClassEditorField.createClassField(project, () -> getModule(), VISIBILITY_CHECKER,
                                                                          createApplicationClassBrowser(project, () -> getModule())));
    }
    {
      // GUI initializer generated by IntelliJ IDEA GUI Designer
      // >>> IMPORTANT!! <<<
      // DO NOT EDIT OR ADD ANY CODE HERE!
      mainPanel = new JPanel();
      mainPanel.setLayout(new GridLayoutManager(7, 2, new Insets(0, 0, 0, 0), -1, -1));
      mainClassEditorField.setLabelLocation("West");
      mainClassEditorField.setText(
        this.$$$getMessageFromBundle$$$("messages/ExecutionBundle", "application.configuration.main.class.label"));
      mainPanel.add(mainClassEditorField, new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                                              GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                              GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                              null, new Dimension(-1, 20), null, 0, false));
      commonProgramParameters = new CommonJavaParametersPanel();
      mainPanel.add(commonProgramParameters, new GridConstraints(1, 0, 1, 2, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                                                 GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                 GridConstraints.SIZEPOLICY_CAN_GROW,
                                                                 GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                 GridConstraints.SIZEPOLICY_CAN_GROW, null, null, null, 0, false));
      final Spacer spacer1 = new Spacer();
      mainPanel.add(spacer1, new GridConstraints(2, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_VERTICAL, 1,
                                                 GridConstraints.SIZEPOLICY_FIXED, null, new Dimension(-1, 10), null, 0, false));
      moduleChooser = new LabeledComponentNoThrow();
      moduleChooser.setComponentClass("com.intellij.application.options.ModuleDescriptionsComboBox");
      moduleChooser.setLabelLocation("West");
      moduleChooser.setText(
        this.$$$getMessageFromBundle$$$("messages/ExecutionBundle", "application.configuration.use.classpath.and.jdk.of.module.label"));
      mainPanel.add(moduleChooser, new GridConstraints(3, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                                       GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                       GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      jrePathEditor = new JrePathEditor();
      mainPanel.add(jrePathEditor, new GridConstraints(4, 0, 1, 2, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                                       GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                       GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null,
                                                       null, null, 0, false));
      final Spacer spacer2 = new Spacer();
      mainPanel.add(spacer2, new GridConstraints(6, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_VERTICAL, 1,
                                                 GridConstraints.SIZEPOLICY_WANT_GROW, null, null, null, 0, false));
      shortenClasspathModeCombo = new LabeledComponentNoThrow();
      shortenClasspathModeCombo.setEnabled(true);
      shortenClasspathModeCombo.setLabelLocation("West");
      shortenClasspathModeCombo.setText(
        this.$$$getMessageFromBundle$$$("messages/ExecutionBundle", "application.configuration.shorten.command.line.label"));
      mainPanel.add(shortenClasspathModeCombo,
                    new GridConstraints(5, 0, 1, 2, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                        GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_WANT_GROW,
                                        GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
    }
    moduleSelector = new ConfigurationModuleSelector(project, moduleChooser.getComponent());
    jrePathEditor.setDefaultJreSelector(DefaultJreSelector.fromModuleDependencies(moduleChooser.getComponent(), false));
    commonProgramParameters.setModuleContext(moduleSelector.getModule());
    moduleChooser.getComponent().addActionListener(new ActionListener() {
      @Override
      public void actionPerformed(ActionEvent e) {
        commonProgramParameters.setModuleContext(moduleSelector.getModule());
      }
    });
    anchor = UIUtil.mergeComponentsWithAnchor(mainClassEditorField, commonProgramParameters, jrePathEditor, jrePathEditor, moduleChooser,
                                              shortenClasspathModeCombo);
    shortenClasspathModeCombo.setComponent(new ShortenCommandLineModeCombo(project, jrePathEditor, moduleChooser.getComponent()));
  }

  private static Method $$$cachedGetBundleMethod$$$ = null;

  /** @noinspection ALL */
  private String $$$getMessageFromBundle$$$(String path, String key) {
    ResourceBundle bundle;
    try {
      Class<?> thisClass = this.getClass();
      if ($$$cachedGetBundleMethod$$$ == null) {
        Class<?> dynamicBundleClass = thisClass.getClassLoader().loadClass("com.intellij.DynamicBundle");
        $$$cachedGetBundleMethod$$$ = dynamicBundleClass.getMethod("getBundle", String.class, Class.class);
      }
      bundle = (ResourceBundle)$$$cachedGetBundleMethod$$$.invoke(null, path, thisClass);
    }
    catch (Exception e) {
      bundle = ResourceBundle.getBundle(path);
    }
    return bundle.getString(key);
  }

  /** @noinspection ALL */
  public JComponent $$$getRootComponent$$$() { return mainPanel; }

  private Module getModule() {
    return moduleSelector.getModule();
  }

  @Override
  protected void applyEditorTo(@NotNull KotlinRunConfiguration configuration) {
    commonProgramParameters.applyTo(configuration);
    moduleSelector.applyTo(configuration);

    configuration.setMainClassName(mainClassEditorField.getComponent().getText());
    configuration.setAlternativeJrePath(jrePathEditor.getJrePathOrName());
    configuration.setAlternativeJrePathEnabled(jrePathEditor.isAlternativeJreSelected());
    configuration.setShortenCommandLine(shortenClasspathModeCombo.getComponent().getSelectedItem());
  }

  @Override
  protected void resetEditorFrom(@NotNull KotlinRunConfiguration configuration) {
    commonProgramParameters.reset(configuration);
    moduleSelector.reset(configuration);
    String mainClassName = configuration.getMainClassName();
    mainClassEditorField.getComponent().setText(mainClassName != null ? mainClassName.replaceAll("\\$", ".") : "");
    jrePathEditor.setPathOrName(configuration.getAlternativeJrePath(), configuration.isAlternativeJrePathEnabled());
    shortenClasspathModeCombo.getComponent().setSelectedItem(configuration.getShortenCommandLine());
  }

  @Override
  protected @NotNull JComponent createEditor() {
    return mainPanel;
  }

  @Override
  public JComponent getAnchor() {
    return anchor;
  }

  @Override
  public void setAnchor(JComponent anchor) {
    this.anchor = anchor;
    mainClassEditorField.setAnchor(anchor);
    commonProgramParameters.setAnchor(anchor);
    jrePathEditor.setAnchor(anchor);
    moduleChooser.setAnchor(anchor);
    shortenClasspathModeCombo.setAnchor(anchor);
  }

  public static final JavaCodeFragment.VisibilityChecker VISIBILITY_CHECKER = (declaration, place) -> {
    if (declaration instanceof KtLightClass aClass) {
      if (ConfigurationUtil.MAIN_CLASS.value(aClass)
          && (PsiMethodUtil.findMainMethod(aClass) != null || place.getParent() != null)
          && ModuleUtilCore.findModuleForPsiElement(declaration) != null) {
        return JavaCodeFragment.VisibilityChecker.Visibility.VISIBLE;
      }
    }
    return JavaCodeFragment.VisibilityChecker.Visibility.NOT_VISIBLE;
  };
}
