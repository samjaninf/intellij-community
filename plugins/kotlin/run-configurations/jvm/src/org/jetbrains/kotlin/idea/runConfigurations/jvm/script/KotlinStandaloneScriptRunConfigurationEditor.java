// Copyright 2000-2025 JetBrains s.r.o. and contributors. Use of this source code is governed by the Apache 2.0 license.

package org.jetbrains.kotlin.idea.runConfigurations.jvm.script;

import com.intellij.execution.ui.CommonJavaParametersPanel;
import com.intellij.execution.ui.DefaultJreSelector;
import com.intellij.execution.ui.JrePathEditor;
import com.intellij.execution.ui.ShortenCommandLineModeCombo;
import com.intellij.openapi.fileChooser.FileChooserDescriptorFactory;
import com.intellij.openapi.options.SettingsEditor;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.ui.LabeledComponentNoThrow;
import com.intellij.openapi.ui.TextComponentAccessor;
import com.intellij.openapi.ui.TextFieldWithBrowseButton;
import com.intellij.ui.PanelWithAnchor;
import com.intellij.uiDesigner.core.GridConstraints;
import com.intellij.uiDesigner.core.GridLayoutManager;
import com.intellij.uiDesigner.core.Spacer;
import com.intellij.util.ui.UIUtil;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.kotlin.idea.KotlinRunConfigurationsBundle;
import org.jetbrains.kotlin.parsing.KotlinParserDefinition;

import javax.swing.JComponent;
import javax.swing.JPanel;
import java.awt.Insets;
import java.lang.reflect.Method;
import java.util.ResourceBundle;

public class KotlinStandaloneScriptRunConfigurationEditor extends SettingsEditor<KotlinStandaloneScriptRunConfiguration>
  implements PanelWithAnchor {
  private final JPanel mainPanel;
  private final CommonJavaParametersPanel commonProgramParameters;
  private final JrePathEditor jrePathEditor;
  private TextFieldWithBrowseButton chooseScriptFileTextField;
  private final LabeledComponentNoThrow<TextFieldWithBrowseButton> chooseScriptFileComponent;
  private final LabeledComponentNoThrow<ShortenCommandLineModeCombo> shortenClasspathModeCombo;
  private JComponent anchor;

  public KotlinStandaloneScriptRunConfigurationEditor(Project project) {
    {
      chooseScriptFileComponent = new LabeledComponentNoThrow<>();
      chooseScriptFileTextField = new TextFieldWithBrowseButton();
      chooseScriptFileComponent.setComponent(chooseScriptFileTextField);
    }
    {
      // GUI initializer generated by IntelliJ IDEA GUI Designer
      // >>> IMPORTANT!! <<<
      // DO NOT EDIT OR ADD ANY CODE HERE!
      mainPanel = new JPanel();
      mainPanel.setLayout(new GridLayoutManager(5, 2, new Insets(0, 0, 0, 0), -1, -1));
      final Spacer spacer1 = new Spacer();
      mainPanel.add(spacer1, new GridConstraints(4, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_VERTICAL, 1,
                                                 GridConstraints.SIZEPOLICY_WANT_GROW, null, null, null, 0, false));
      commonProgramParameters = new CommonJavaParametersPanel();
      mainPanel.add(commonProgramParameters, new GridConstraints(1, 0, 1, 2, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                                                 GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                 GridConstraints.SIZEPOLICY_CAN_GROW,
                                                                 GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                 GridConstraints.SIZEPOLICY_CAN_GROW, null, null, null, 0, false));
      jrePathEditor = new JrePathEditor();
      mainPanel.add(jrePathEditor, new GridConstraints(2, 0, 1, 2, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                                       GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                       GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null,
                                                       null, null, 0, false));
      chooseScriptFileComponent.setLabelLocation("West");
      chooseScriptFileComponent.setText(
        this.$$$getMessageFromBundle$$$("messages/KotlinRunConfigurationsBundle", "configuration.title.script.file"));
      mainPanel.add(chooseScriptFileComponent, new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_BOTH,
                                                                   GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                   GridConstraints.SIZEPOLICY_CAN_GROW,
                                                                   GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                   GridConstraints.SIZEPOLICY_CAN_GROW, null, null, null, 0, false));
      shortenClasspathModeCombo = new LabeledComponentNoThrow();
      shortenClasspathModeCombo.setEnabled(true);
      shortenClasspathModeCombo.setLabelLocation("West");
      shortenClasspathModeCombo.setText(
        this.$$$getMessageFromBundle$$$("messages/ExecutionBundle", "application.configuration.shorten.command.line.label"));
      mainPanel.add(shortenClasspathModeCombo,
                    new GridConstraints(3, 0, 1, 2, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                        GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_WANT_GROW,
                                        GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
    }
    initChooseFileField(project);
    jrePathEditor.setDefaultJreSelector(DefaultJreSelector.projectSdk(project));
    anchor = UIUtil.mergeComponentsWithAnchor(chooseScriptFileComponent, commonProgramParameters, jrePathEditor, shortenClasspathModeCombo);
    shortenClasspathModeCombo.setComponent(new ShortenCommandLineModeCombo(project, jrePathEditor, () -> null, listener -> {
    }));
  }

  private static Method $$$cachedGetBundleMethod$$$ = null;

  /** @noinspection ALL */
  private String $$$getMessageFromBundle$$$(String path, String key) {
    ResourceBundle bundle;
    try {
      Class<?> thisClass = this.getClass();
      if ($$$cachedGetBundleMethod$$$ == null) {
        Class<?> dynamicBundleClass = thisClass.getClassLoader().loadClass("com.intellij.DynamicBundle");
        $$$cachedGetBundleMethod$$$ = dynamicBundleClass.getMethod("getBundle", String.class, Class.class);
      }
      bundle = (ResourceBundle)$$$cachedGetBundleMethod$$$.invoke(null, path, thisClass);
    }
    catch (Exception e) {
      bundle = ResourceBundle.getBundle(path);
    }
    return bundle.getString(key);
  }

  /** @noinspection ALL */
  public JComponent $$$getRootComponent$$$() { return mainPanel; }

  void initChooseFileField(Project project) {
    var descriptor = FileChooserDescriptorFactory.createSingleFileDescriptor(KotlinParserDefinition.STD_SCRIPT_SUFFIX)
      .withTitle(KotlinRunConfigurationsBundle.message("script.choose.file"))
      .withTreeRootVisible(true);
    chooseScriptFileTextField.addBrowseFolderListener(project, descriptor, TextComponentAccessor.TEXT_FIELD_WHOLE_TEXT);
  }

  @Override
  protected void resetEditorFrom(@NotNull KotlinStandaloneScriptRunConfiguration configuration) {
    commonProgramParameters.reset(configuration);
    String path = configuration.filePath;
    chooseScriptFileTextField.setText(path != null ? path : "");
    jrePathEditor.setPathOrName(configuration.getAlternativeJrePath(), configuration.isAlternativeJrePathEnabled());
    shortenClasspathModeCombo.getComponent().setSelectedItem(configuration.getShortenCommandLine());
  }

  @Override
  protected void applyEditorTo(@NotNull KotlinStandaloneScriptRunConfiguration configuration) {
    commonProgramParameters.applyTo(configuration);
    configuration.setAlternativeJrePath(jrePathEditor.getJrePathOrName());
    configuration.setAlternativeJrePathEnabled(jrePathEditor.isAlternativeJreSelected());
    configuration.filePath = chooseScriptFileTextField.getText();
    configuration.setShortenCommandLine(shortenClasspathModeCombo.getComponent().getSelectedItem());
  }

  @Override
  protected @NotNull JComponent createEditor() {
    return mainPanel;
  }

  @Override
  public JComponent getAnchor() {
    return anchor;
  }

  @Override
  public void setAnchor(JComponent anchor) {
    this.anchor = anchor;
    commonProgramParameters.setAnchor(anchor);
    jrePathEditor.setAnchor(anchor);
    chooseScriptFileComponent.setAnchor(anchor);
    shortenClasspathModeCombo.setAnchor(anchor);
  }
}
