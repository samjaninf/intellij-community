// Copyright 2000-2024 JetBrains s.r.o. and contributors. Use of this source code is governed by the Apache 2.0 license.
package com.intellij.codeInsight.actions;

import com.intellij.application.options.CodeStyle;
import com.intellij.codeInsight.CodeInsightBundle;
import com.intellij.ide.util.PropertiesComponent;
import com.intellij.lang.LanguageImportStatements;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.ui.DialogWrapper;
import com.intellij.openapi.util.NlsContexts;
import com.intellij.psi.PsiFile;
import com.intellij.psi.codeStyle.arrangement.Rearranger;
import com.intellij.testFramework.LightVirtualFile;
import com.intellij.ui.IdeBorderFactory;
import com.intellij.ui.components.JBCheckBox;
import com.intellij.uiDesigner.core.GridConstraints;
import com.intellij.uiDesigner.core.GridLayoutManager;
import com.intellij.uiDesigner.core.Spacer;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;

import javax.swing.AbstractButton;
import javax.swing.BorderFactory;
import javax.swing.ButtonGroup;
import javax.swing.JCheckBox;
import javax.swing.JComponent;
import javax.swing.JPanel;
import javax.swing.JRadioButton;
import javax.swing.border.TitledBorder;
import java.awt.Dimension;
import java.awt.Insets;
import java.lang.reflect.Method;
import java.util.ResourceBundle;

public final class LayoutCodeDialog extends DialogWrapper {
  private final PsiFile myPsiFile;
  private final boolean myTextSelected;
  private final String myHelpId;
  private final LastRunReformatCodeOptionsProvider myLastRunOptions;
  private final LayoutCodeOptions myRunOptions;

  private final JPanel myButtonsPanel;
  private final JCheckBox myOptimizeImportsCb;
  private final JCheckBox myRearrangeCodeCb;
  private final JCheckBox myApplyCodeCleanup;
  private final JRadioButton myOnlyVCSChangedTextRb;
  private final JRadioButton mySelectedTextRadioButton;
  private final JRadioButton myWholeFileRadioButton;
  private final JBCheckBox myDoNotKeepLineBreaks;

  public LayoutCodeDialog(@NotNull Project project, @NotNull PsiFile psiFile, boolean textSelected, String helpId) {
    super(project, true);
    myPsiFile = psiFile;
    myTextSelected = textSelected;
    myHelpId = helpId;
    {
      // GUI initializer generated by IntelliJ IDEA GUI Designer
      // >>> IMPORTANT!! <<<
      // DO NOT EDIT OR ADD ANY CODE HERE!
      myButtonsPanel = new JPanel();
      myButtonsPanel.setLayout(new GridLayoutManager(3, 1, new Insets(0, 0, 0, 0), -1, -1));
      myButtonsPanel.setMinimumSize(new Dimension(400, 222));
      final JPanel panel1 = new JPanel();
      panel1.setLayout(new GridLayoutManager(3, 1, new Insets(0, 0, 0, 0), -1, -1));
      panel1.putClientProperty("BorderFactoryClass", "com.intellij.ui.IdeBorderFactory$PlainSmallWithoutIndent");
      myButtonsPanel.add(panel1, new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_BOTH,
                                                     GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                     GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null,
                                                     null, null, 0, false));
      panel1.setBorder(IdeBorderFactory.PlainSmallWithoutIndent.createTitledBorder(BorderFactory.createEtchedBorder(),
                                                                                   this.$$$getMessageFromBundle$$$(
                                                                                     "messages/CodeInsightBundle", "reformat.scope.panel"),
                                                                                   TitledBorder.DEFAULT_JUSTIFICATION,
                                                                                   TitledBorder.DEFAULT_POSITION, null, null));
      myOnlyVCSChangedTextRb = new JRadioButton();
      myOnlyVCSChangedTextRb.setMargin(new Insets(0, 0, 0, 0));
      this.$$$loadButtonText$$$(myOnlyVCSChangedTextRb, this.$$$getMessageFromBundle$$$("messages/CodeInsightBundle",
                                                                                        "radio.button.reformat.only.vcs.changed.text"));
      panel1.add(myOnlyVCSChangedTextRb, new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                             GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                             GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      mySelectedTextRadioButton = new JRadioButton();
      mySelectedTextRadioButton.setMargin(new Insets(0, 0, 0, 0));
      this.$$$loadButtonText$$$(mySelectedTextRadioButton,
                                this.$$$getMessageFromBundle$$$("messages/CodeInsightBundle", "radio.button.reformat.selected.text"));
      panel1.add(mySelectedTextRadioButton, new GridConstraints(1, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                                GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                                GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myWholeFileRadioButton = new JRadioButton();
      myWholeFileRadioButton.setMargin(new Insets(0, 0, 0, 0));
      this.$$$loadButtonText$$$(myWholeFileRadioButton,
                                this.$$$getMessageFromBundle$$$("messages/CodeInsightBundle", "radio.button.reformat.whole.file"));
      panel1.add(myWholeFileRadioButton, new GridConstraints(2, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                             GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                             GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      final Spacer spacer1 = new Spacer();
      myButtonsPanel.add(spacer1, new GridConstraints(2, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_VERTICAL, 1,
                                                      GridConstraints.SIZEPOLICY_WANT_GROW, null, null, null, 0, false));
      final JPanel panel2 = new JPanel();
      panel2.setLayout(new GridLayoutManager(2, 2, new Insets(0, 0, 0, 0), -1, -1));
      panel2.putClientProperty("BorderFactoryClass", "com.intellij.ui.IdeBorderFactory$PlainSmallWithoutIndent");
      myButtonsPanel.add(panel2, new GridConstraints(1, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_BOTH,
                                                     GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                     GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null,
                                                     null, null, 0, false));
      panel2.setBorder(IdeBorderFactory.PlainSmallWithoutIndent.createTitledBorder(BorderFactory.createEtchedBorder(),
                                                                                   this.$$$getMessageFromBundle$$$(
                                                                                     "messages/CodeInsightBundle",
                                                                                     "reformat.options.panel"),
                                                                                   TitledBorder.DEFAULT_JUSTIFICATION,
                                                                                   TitledBorder.DEFAULT_POSITION, null, null));
      myOptimizeImportsCb = new JCheckBox();
      myOptimizeImportsCb.setMargin(new Insets(0, 0, 0, 0));
      this.$$$loadButtonText$$$(myOptimizeImportsCb,
                                this.$$$getMessageFromBundle$$$("messages/CodeInsightBundle", "checkbox.optimize.imports"));
      panel2.add(myOptimizeImportsCb, new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                          GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                          GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myRearrangeCodeCb = new JCheckBox();
      myRearrangeCodeCb.setMargin(new Insets(0, 0, 0, 0));
      this.$$$loadButtonText$$$(myRearrangeCodeCb,
                                this.$$$getMessageFromBundle$$$("messages/CodeInsightBundle", "checkbox.rearrange.code"));
      panel2.add(myRearrangeCodeCb, new GridConstraints(0, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                        GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                        GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myApplyCodeCleanup = new JCheckBox();
      myApplyCodeCleanup.setMargin(new Insets(0, 0, 0, 0));
      this.$$$loadButtonText$$$(myApplyCodeCleanup, this.$$$getMessageFromBundle$$$("messages/CodeInsightBundle", "checkbox.code.cleanup"));
      panel2.add(myApplyCodeCleanup, new GridConstraints(1, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                         GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                         GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myDoNotKeepLineBreaks = new JBCheckBox();
      this.$$$loadButtonText$$$(myDoNotKeepLineBreaks,
                                this.$$$getMessageFromBundle$$$("messages/CodeInsightBundle", "do.not.keep.line.breaks"));
      panel2.add(myDoNotKeepLineBreaks,
                 new GridConstraints(1, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                     GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      ButtonGroup buttonGroup;
      buttonGroup = new ButtonGroup();
      buttonGroup.add(mySelectedTextRadioButton);
      buttonGroup.add(myWholeFileRadioButton);
      buttonGroup.add(myOnlyVCSChangedTextRb);
    }

    myLastRunOptions = new LastRunReformatCodeOptionsProvider(PropertiesComponent.getInstance());
    myRunOptions = createOptionsBundledOnDialog();

    setOKButtonText(CodeInsightBundle.message("reformat.code.accept.button.text"));
    setTitle(CodeInsightBundle.message("dialog.title.reformat.file.0", psiFile.getName()));

    init();
  }

  private static Method $$$cachedGetBundleMethod$$$ = null;

  /** @noinspection ALL */
  private String $$$getMessageFromBundle$$$(String path, String key) {
    ResourceBundle bundle;
    try {
      Class<?> thisClass = this.getClass();
      if ($$$cachedGetBundleMethod$$$ == null) {
        Class<?> dynamicBundleClass = thisClass.getClassLoader().loadClass("com.intellij.DynamicBundle");
        $$$cachedGetBundleMethod$$$ = dynamicBundleClass.getMethod("getBundle", String.class, Class.class);
      }
      bundle = (ResourceBundle)$$$cachedGetBundleMethod$$$.invoke(null, path, thisClass);
    }
    catch (Exception e) {
      bundle = ResourceBundle.getBundle(path);
    }
    return bundle.getString(key);
  }

  /** @noinspection ALL */
  private void $$$loadButtonText$$$(AbstractButton component, String text) {
    StringBuffer result = new StringBuffer();
    boolean haveMnemonic = false;
    char mnemonic = '\0';
    int mnemonicIndex = -1;
    for (int i = 0; i < text.length(); i++) {
      if (text.charAt(i) == '&') {
        i++;
        if (i == text.length()) break;
        if (!haveMnemonic && text.charAt(i) != '&') {
          haveMnemonic = true;
          mnemonic = text.charAt(i);
          mnemonicIndex = result.length();
        }
      }
      result.append(text.charAt(i));
    }
    component.setText(result.toString());
    if (haveMnemonic) {
      component.setMnemonic(mnemonic);
      component.setDisplayedMnemonicIndex(mnemonicIndex);
    }
  }

  /** @noinspection ALL */
  public JComponent $$$getRootComponent$$$() { return myButtonsPanel; }

  @Override
  protected void init() {
    super.init();

    setUpActions();
    setUpTextRangeMode();
  }


  private void setUpTextRangeMode() {
    mySelectedTextRadioButton.setEnabled(myTextSelected);
    if (!myTextSelected) {
      mySelectedTextRadioButton.setToolTipText(CodeInsightBundle.message("tooltip.no.text.selected.in.editor"));
    }

    final boolean fileHasChanges = VcsFacade.getInstance().hasChanges(myPsiFile);
    if (myPsiFile.getVirtualFile() instanceof LightVirtualFile) {
      myOnlyVCSChangedTextRb.setVisible(false);
    }
    else {
      myOnlyVCSChangedTextRb.setEnabled(fileHasChanges);
      if (!fileHasChanges) {
        String hint = getChangesNotAvailableHint();
        if (hint != null) myOnlyVCSChangedTextRb.setToolTipText(hint);
      }
    }

    myWholeFileRadioButton.setEnabled(true);

    if (myTextSelected) {
      mySelectedTextRadioButton.setSelected(true);
    }
    else {
      boolean lastRunProcessedChangedText = myLastRunOptions.getLastTextRangeType() == TextRangeType.VCS_CHANGED_TEXT;
      if (lastRunProcessedChangedText && fileHasChanges) {
        myOnlyVCSChangedTextRb.setSelected(true);
      }
      else {
        myWholeFileRadioButton.setSelected(true);
      }
    }
  }

  private void setUpActions() {
    boolean canOptimizeImports = !LanguageImportStatements.INSTANCE.forFile(myPsiFile).isEmpty();
    myOptimizeImportsCb.setVisible(canOptimizeImports);
    if (canOptimizeImports) {
      myOptimizeImportsCb.setSelected(myLastRunOptions.getLastOptimizeImports());
    }

    boolean canRearrangeCode = Rearranger.EXTENSION.forLanguage(myPsiFile.getLanguage()) != null;
    myRearrangeCodeCb.setVisible(canRearrangeCode);
    if (canRearrangeCode) {
      myRearrangeCodeCb.setSelected(myLastRunOptions.isRearrangeCode(myPsiFile.getLanguage()));
    }

    myApplyCodeCleanup.setSelected(myLastRunOptions.getLastCodeCleanup());

    boolean keepLineBreaks = CodeStyle.getLanguageSettings(myPsiFile).KEEP_LINE_BREAKS;
    myDoNotKeepLineBreaks.setVisible(keepLineBreaks);
    if (keepLineBreaks) {
      myDoNotKeepLineBreaks.setSelected(myLastRunOptions.isDoNotKeepLineBreaks());
    }
  }

  private @Nullable @NlsContexts.Tooltip String getChangesNotAvailableHint() {
    if (!VcsFacade.getInstance().isFileUnderVcs(myPsiFile)) {
      return CodeInsightBundle.message("tooltip.file.not.under.vcs.root");
    }
    else if (!VcsFacade.getInstance().hasChanges(myPsiFile)) {
      return CodeInsightBundle.message("tooltip.file.was.not.changed.since.last.revision");
    }
    return null;
  }

  private void saveCurrentConfiguration() {
    if (myOptimizeImportsCb.isEnabled() && myOptimizeImportsCb.isVisible()) {
      myLastRunOptions.saveOptimizeImportsState(myRunOptions.isOptimizeImports());
    }
    if (myRearrangeCodeCb.isEnabled()) {
      myLastRunOptions.saveRearrangeState(myPsiFile.getLanguage(), myRunOptions.isRearrangeCode());
    }
    if (myApplyCodeCleanup.isEnabled()) {
      myLastRunOptions.saveCodeCleanupState(myApplyCodeCleanup.isSelected());
    }

    if (!mySelectedTextRadioButton.isSelected() && myOnlyVCSChangedTextRb.isEnabled()) {
      myLastRunOptions.saveProcessVcsChangedTextState(myOnlyVCSChangedTextRb.isSelected());
    }
    if (myDoNotKeepLineBreaks.isVisible()) {
      myLastRunOptions.setDoNotKeepLineBreaks(myDoNotKeepLineBreaks.isSelected());
    }
  }

  private LayoutCodeOptions createOptionsBundledOnDialog() {
    return new LayoutCodeOptions() {
      @Override
      public TextRangeType getTextRangeType() {
        if (myOnlyVCSChangedTextRb.isSelected()) {
          return TextRangeType.VCS_CHANGED_TEXT;
        }
        if (mySelectedTextRadioButton.isSelected()) {
          return TextRangeType.SELECTED_TEXT;
        }
        return TextRangeType.WHOLE_FILE;
      }

      @Override
      public boolean isRearrangeCode() {
        return myRearrangeCodeCb.isEnabled() && myRearrangeCodeCb.isSelected();
      }

      @Override
      public boolean isOptimizeImports() {
        return myOptimizeImportsCb.isEnabled() && myOptimizeImportsCb.isSelected();
      }

      @Override
      public boolean isCodeCleanup() {
        return myApplyCodeCleanup.isEnabled() && myApplyCodeCleanup.isSelected();
      }

      @Override
      public boolean doNotKeepLineBreaks() {
        return myDoNotKeepLineBreaks.isEnabled() && myDoNotKeepLineBreaks.isSelected();
      }
    };
  }

  @Override
  protected @Nullable JComponent createCenterPanel() {
    return myButtonsPanel;
  }

  @Override
  protected @Nullable String getHelpId() {
    return myHelpId;
  }

  @Override
  protected void doOKAction() {
    saveCurrentConfiguration();
    super.doOKAction();
  }

  public LayoutCodeOptions getRunOptions() {
    return myRunOptions;
  }
}