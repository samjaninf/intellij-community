// Copyright 2000-2025 JetBrains s.r.o. and contributors. Use of this source code is governed by the Apache 2.0 license.
package com.intellij.openapi.fileTypes.ex;

import com.intellij.openapi.application.ApplicationManager;
import com.intellij.openapi.application.ApplicationNamesInfo;
import com.intellij.openapi.fileTypes.FileType;
import com.intellij.openapi.fileTypes.FileTypeManager;
import com.intellij.openapi.fileTypes.FileTypes;
import com.intellij.openapi.fileTypes.FileTypesBundle;
import com.intellij.openapi.fileTypes.NativeFileType;
import com.intellij.openapi.fileTypes.impl.DetectedByContentFileType;
import com.intellij.openapi.fileTypes.impl.FileTypeRenderer;
import com.intellij.openapi.options.ShowSettingsUtil;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.ui.ComboBox;
import com.intellij.openapi.ui.DialogWrapper;
import com.intellij.openapi.util.text.StringUtil;
import com.intellij.openapi.vfs.VirtualFile;
import com.intellij.openapi.vfs.newvfs.impl.FakeVirtualFile;
import com.intellij.ui.CollectionComboBoxModel;
import com.intellij.ui.DoubleClickListener;
import com.intellij.ui.ListSpeedSearch;
import com.intellij.ui.ScrollingUtil;
import com.intellij.ui.components.JBLabel;
import com.intellij.ui.components.JBList;
import com.intellij.ui.components.JBScrollPane;
import com.intellij.uiDesigner.core.GridConstraints;
import com.intellij.uiDesigner.core.GridLayoutManager;
import com.intellij.util.concurrency.annotations.RequiresEdt;
import com.intellij.util.ui.NamedColorUtil;
import com.intellij.util.ui.UIUtil;
import org.jetbrains.annotations.ApiStatus;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;
import org.jetbrains.annotations.VisibleForTesting;

import javax.swing.AbstractButton;
import javax.swing.ButtonGroup;
import javax.swing.DefaultListModel;
import javax.swing.JComponent;
import javax.swing.JLabel;
import javax.swing.JList;
import javax.swing.JPanel;
import javax.swing.JRadioButton;
import javax.swing.ListSelectionModel;
import java.awt.Dimension;
import java.awt.Insets;
import java.awt.event.ActionListener;
import java.awt.event.MouseEvent;
import java.lang.reflect.Method;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.LinkedList;
import java.util.List;
import java.util.ResourceBundle;

public final class FileTypeChooser extends DialogWrapper {
  private final JList<FileType> myList;
  private final JLabel myTitleLabel;
  private final ComboBox<String> myPattern;
  private final JPanel myPanel;
  private final JRadioButton myOpenInIdea;
  private final JRadioButton myOpenAsNative;
  private final JRadioButton myDetectFileType;
  private final JBLabel myContextHelpLabel;
  private final String myFileName;

  private FileTypeChooser(@NotNull List<String> patterns, @NotNull String fileName) {
    super(true);

    myFileName = fileName;
    {
      // GUI initializer generated by IntelliJ IDEA GUI Designer
      // >>> IMPORTANT!! <<<
      // DO NOT EDIT OR ADD ANY CODE HERE!
      myPanel = new JPanel();
      myPanel.setLayout(new GridLayoutManager(7, 2, new Insets(0, 0, 0, 0), -1, -1));
      myTitleLabel = new JLabel();
      myTitleLabel.setText("Cannot associate _template_"); //NON-NLS
      myPanel.add(myTitleLabel,
                  new GridConstraints(0, 0, 1, 2, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                      GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      final JLabel label1 = new JLabel();
      this.$$$loadLabelText$$$(label1, this.$$$getMessageFromBundle$$$("messages/FileTypesBundle", "filetype.chooser.file.pattern"));
      myPanel.add(label1,
                  new GridConstraints(1, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                      GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myPattern = new ComboBox();
      myPattern.setEditable(true);
      myPanel.add(myPattern, new GridConstraints(1, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_HORIZONTAL,
                                                 GridConstraints.SIZEPOLICY_WANT_GROW, GridConstraints.SIZEPOLICY_FIXED, null,
                                                 new Dimension(150, -1), null, 0, false));
      final JBScrollPane jBScrollPane1 = new JBScrollPane();
      myPanel.add(jBScrollPane1, new GridConstraints(5, 0, 1, 2, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_BOTH,
                                                     GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_WANT_GROW,
                                                     GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_WANT_GROW, null,
                                                     new Dimension(150, 200), null, 2, false));
      myList = new JBList();
      jBScrollPane1.setViewportView(myList);
      myOpenInIdea = new JRadioButton();
      myOpenInIdea.setSelected(true);
      myOpenInIdea.setText("Open matching files in PRODUCTNAME as type:"); //NON-NLS
      myPanel.add(myOpenInIdea, new GridConstraints(4, 0, 1, 2, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                    GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                    GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myOpenAsNative = new JRadioButton();
      this.$$$loadButtonText$$$(myOpenAsNative, this.$$$getMessageFromBundle$$$("messages/IdeBundle",
                                                                                "radio.button.open.matching.files.in.associated.application"));
      myPanel.add(myOpenAsNative, new GridConstraints(6, 0, 1, 2, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                      GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                      GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myDetectFileType = new JRadioButton();
      myDetectFileType.setText("Open matching files in PRODUCTNAME and auto-detect file type"); //NON-NLS
      myPanel.add(myDetectFileType, new GridConstraints(3, 0, 1, 2, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                        GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                        GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myContextHelpLabel = new JBLabel();
      myPanel.add(myContextHelpLabel,
                  new GridConstraints(2, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                      GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      label1.setLabelFor(myPattern);
      ButtonGroup buttonGroup;
      buttonGroup = new ButtonGroup();
      buttonGroup.add(myOpenInIdea);
      buttonGroup.add(myOpenAsNative);
      buttonGroup.add(myDetectFileType);
    }
    myOpenInIdea.setText(FileTypesBundle.message("filetype.chooser.association", ApplicationNamesInfo.getInstance().getFullProductName()));
    myDetectFileType.setText(FileTypesBundle.message("filetype.chooser.autodetect"));
    ActionListener actionListener = e -> {
      myList.setEnabled(myOpenInIdea.isSelected());
      updateContextHelp();
    };
    myDetectFileType.addActionListener(actionListener);
    myOpenInIdea.addActionListener(actionListener);
    myOpenAsNative.addActionListener(actionListener);

    if (fileName.indexOf('.') < 0) {
      myDetectFileType.setSelected(true);
      myList.setEnabled(false);
    }

    var fileTypes = FileTypeManager.getInstance().getRegisteredFileTypes();
    Arrays.sort(fileTypes,
                (ft1, ft2) -> ft1 == null ? 1 : ft2 == null ? -1 : ft1.getDescription().compareToIgnoreCase(ft2.getDescription()));

    var model = new DefaultListModel<FileType>();
    for (var type : fileTypes) {
      if (!type.isReadOnly() &&
          type != FileTypes.UNKNOWN &&
          !(type instanceof NativeFileType) &&
          type != DetectedByContentFileType.INSTANCE) {
        model.addElement(type);
      }
    }
    myList.setModel(model);
    myList.addListSelectionListener(e -> updateContextHelp());
    myPattern.setModel(new CollectionComboBoxModel<>(new ArrayList<>(patterns), patterns.get(0)));
    ListSpeedSearch.installOn(myList, o -> o.getDescription());

    myContextHelpLabel.setForeground(UIUtil.getContextHelpForeground());
    updateContextHelp();
    setTitle(FileTypesBundle.message("filetype.chooser.title"));
    init();
  }

  private static Method $$$cachedGetBundleMethod$$$ = null;

  /** @noinspection ALL */
  private String $$$getMessageFromBundle$$$(String path, String key) {
    ResourceBundle bundle;
    try {
      Class<?> thisClass = this.getClass();
      if ($$$cachedGetBundleMethod$$$ == null) {
        Class<?> dynamicBundleClass = thisClass.getClassLoader().loadClass("com.intellij.DynamicBundle");
        $$$cachedGetBundleMethod$$$ = dynamicBundleClass.getMethod("getBundle", String.class, Class.class);
      }
      bundle = (ResourceBundle)$$$cachedGetBundleMethod$$$.invoke(null, path, thisClass);
    }
    catch (Exception e) {
      bundle = ResourceBundle.getBundle(path);
    }
    return bundle.getString(key);
  }

  /** @noinspection ALL */
  private void $$$loadLabelText$$$(JLabel component, String text) {
    StringBuffer result = new StringBuffer();
    boolean haveMnemonic = false;
    char mnemonic = '\0';
    int mnemonicIndex = -1;
    for (int i = 0; i < text.length(); i++) {
      if (text.charAt(i) == '&') {
        i++;
        if (i == text.length()) break;
        if (!haveMnemonic && text.charAt(i) != '&') {
          haveMnemonic = true;
          mnemonic = text.charAt(i);
          mnemonicIndex = result.length();
        }
      }
      result.append(text.charAt(i));
    }
    component.setText(result.toString());
    if (haveMnemonic) {
      component.setDisplayedMnemonic(mnemonic);
      component.setDisplayedMnemonicIndex(mnemonicIndex);
    }
  }

  /** @noinspection ALL */
  private void $$$loadButtonText$$$(AbstractButton component, String text) {
    StringBuffer result = new StringBuffer();
    boolean haveMnemonic = false;
    char mnemonic = '\0';
    int mnemonicIndex = -1;
    for (int i = 0; i < text.length(); i++) {
      if (text.charAt(i) == '&') {
        i++;
        if (i == text.length()) break;
        if (!haveMnemonic && text.charAt(i) != '&') {
          haveMnemonic = true;
          mnemonic = text.charAt(i);
          mnemonicIndex = result.length();
        }
      }
      result.append(text.charAt(i));
    }
    component.setText(result.toString());
    if (haveMnemonic) {
      component.setMnemonic(mnemonic);
      component.setDisplayedMnemonicIndex(mnemonicIndex);
    }
  }

  /** @noinspection ALL */
  public JComponent $$$getRootComponent$$$() { return myPanel; }

  private void updateContextHelp() {
    var selectedType = getSelectedType();
    var fileTypeString = selectedType == null ? "" : (" | " + selectedType.getDescription());
    myContextHelpLabel.setText(FileTypesBundle.message("label.help.change.association", ShowSettingsUtil.getSettingsMenuName(),
                                                       fileTypeString));
  }

  @Override
  protected JComponent createCenterPanel() {
    var fileType = FileTypeManager.getInstance().getFileTypeByFileName(myFileName);
    myTitleLabel.setText(fileType == FileTypes.UNKNOWN ?
                         FileTypesBundle.message("filetype.chooser.prompt", myFileName) :
                         FileTypesBundle.message("filetype.chooser.change.prompt", myFileName, fileType.getName()));

    myList.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);
    myList.setCellRenderer(new FileTypeRenderer() {
      @Override
      public void customize(@NotNull JList<? extends FileType> list, FileType value, int index, boolean selected, boolean hasFocus) {
        super.customize(list, value, index, selected, hasFocus);
        if (!myOpenInIdea.isSelected()) {
          setForeground(selected ? NamedColorUtil.getListSelectionForeground(hasFocus) : UIUtil.getComboBoxDisabledForeground());
          setBackground(selected ? UIUtil.getListSelectionBackground(hasFocus) : UIUtil.getComboBoxDisabledBackground());
        }
      }
    });

    new DoubleClickListener() {
      @Override
      protected boolean onDoubleClick(@NotNull MouseEvent e) {
        doOKAction();
        return true;
      }
    }.installOn(myList);

    myList.getSelectionModel().addListSelectionListener(__ -> updateButtonsState());

    ScrollingUtil.selectItem(myList, FileTypes.PLAIN_TEXT);

    return myPanel;
  }

  @Override
  public JComponent getPreferredFocusedComponent() {
    return myList.isEnabled() ? myList : myDetectFileType;
  }

  private void updateButtonsState() {
    setOKActionEnabled(myList.getSelectedIndex() != -1 || myOpenAsNative.isSelected() || myDetectFileType.isSelected());
  }

  @Override
  protected String getDimensionServiceKey() {
    return "#com.intellij.fileTypes.FileTypeChooser";
  }

  public FileType getSelectedType() {
    return myDetectFileType.isSelected() ? DetectedByContentFileType.INSTANCE :
           myOpenAsNative.isSelected() ? NativeFileType.INSTANCE :
           myList.getSelectedValue();
  }

  /** @deprecated Method requires both EDT and BGT. Use {@link #associateFileType(String)} directly */
  @Deprecated(forRemoval = true)
  public static @Nullable FileType getKnownFileTypeOrAssociate(@NotNull VirtualFile file,
                                                               @SuppressWarnings("unused") @Nullable Project project) {
    var type = file.getFileType();
    if (type == FileTypes.UNKNOWN) {
      type = getKnownFileTypeOrAssociate(file.getName());
    }
    return type;
  }

  /** @deprecated Method requires both EDT and BGT. Use {@link #associateFileType(String)} directly */
  @Deprecated(forRemoval = true)
  public static @Nullable FileType getKnownFileTypeOrAssociate(@NotNull VirtualFile parent,
                                                               @NotNull String newName,
                                                               @Nullable Project project) {
    return getKnownFileTypeOrAssociate(new FakeVirtualFile(parent, newName), project);
  }

  public static @Nullable FileType getKnownFileTypeOrAssociate(@NotNull String fileName) {
    var fileTypeManager = FileTypeManager.getInstance();
    var type = fileTypeManager.getFileTypeByFileName(fileName);
    if (type == FileTypes.UNKNOWN) {
      type = associateFileType(fileName);
    }
    return type;
  }

  @RequiresEdt
  public static @Nullable FileType associateFileType(@NotNull String fileName) {
    var chooser = new FileTypeChooser(suggestPatterns(fileName), fileName);
    if (!chooser.showAndGet()) {
      return null;
    }
    var type = chooser.getSelectedType();
    if (type == FileTypes.UNKNOWN || type == null) return null;

    ApplicationManager.getApplication()
      .runWriteAction(() -> FileTypeManagerEx.getInstanceEx().associatePattern(type, chooser.getSelectedPattern()));

    return type;
  }

  private String getSelectedPattern() {
    return (String)myPattern.getSelectedItem();
  }

  @VisibleForTesting
  @ApiStatus.Internal
  public static @NotNull List<String> suggestPatterns(@NotNull String fileName) {
    var patterns = new LinkedList<String>();

    var i = -1;
    while ((i = fileName.indexOf('.', i + 1)) > 0) {
      var extension = fileName.substring(i);
      if (!StringUtil.isEmpty(extension)) {
        patterns.add(0, "*" + extension);
      }
    }
    if (FileTypeManager.getInstance().getFileTypeByFileName(fileName) == FileTypes.UNKNOWN) {
      patterns.add(fileName);
    }
    else {
      patterns.add(0, fileName);
    }

    return patterns;
  }

  @Override
  protected String getHelpId() {
    return "reference.dialogs.register.association";
  }
}
