// Copyright 2000-2024 JetBrains s.r.o. and contributors. Use of this source code is governed by the Apache 2.0 license.
package com.jetbrains.python.debugger;

import com.intellij.icons.AllIcons;
import com.intellij.ide.IdeTooltipManager;
import com.intellij.openapi.options.Configurable;
import com.intellij.openapi.options.SearchableConfigurable;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.ui.ComboBox;
import com.intellij.openapi.ui.Messages;
import com.intellij.openapi.util.NlsSafe;
import com.intellij.openapi.util.registry.Registry;
import com.intellij.openapi.util.text.StringUtil;
import com.intellij.ui.JBIntSpinner;
import com.intellij.ui.TooltipWithClickableLinks;
import com.intellij.ui.components.ActionLink;
import com.intellij.ui.components.JBCheckBox;
import com.intellij.ui.components.JBLabel;
import com.intellij.ui.components.JBTextField;
import com.intellij.uiDesigner.core.GridConstraints;
import com.intellij.uiDesigner.core.GridLayoutManager;
import com.intellij.uiDesigner.core.Spacer;
import com.jetbrains.python.PyBundle;
import org.jetbrains.annotations.Nls;
import org.jetbrains.annotations.NotNull;

import javax.swing.AbstractButton;
import javax.swing.JCheckBox;
import javax.swing.JComponent;
import javax.swing.JLabel;
import javax.swing.JPanel;
import java.awt.Dimension;
import java.awt.Insets;
import java.awt.event.ItemEvent;
import java.awt.event.ItemListener;
import java.lang.reflect.Method;
import java.util.Arrays;
import java.util.ResourceBundle;
import java.util.function.Supplier;

public final class PyDebuggerConfigurable implements SearchableConfigurable, Configurable.NoScroll {
  private final JPanel myMainPanel;
  private final JCheckBox myAttachToSubprocess;
  private final JCheckBox mySaveSignatures;
  private final JCheckBox mySupportGevent;
  private final JBCheckBox mySupportQt;
  private final JCheckBox myDropIntoDebuggerOnFailedTests;
  private final JBLabel warningIcon;
  private final ComboBox<PyQtBackend> myPyQtBackend;
  private final ActionLink myActionLink;
  private final JBTextField myAttachProcessFilter;
  private final JBLabel myAttachFilterLabel;
  private final JBLabel myDebuggerPortLabel;
  private final JBIntSpinner myDebuggerPort;
  private final JBCheckBox myRunDebuggerInServerMode;
  private final JPanel myDebuggerPortPanel;
  private final JBLabel myDebuggerEvaluationResponseTimeoutLabel;
  private final JBIntSpinner myDebuggerEvaluationResponseTimeout;

  private enum PyQtBackend {
    AUTO(PyBundle.messagePointer("python.debugger.qt.backend.auto")),
    PYQT4("PyQt4"),
    PYQT5("PyQt5"),
    PYQT6("PyQt6"),
    PYSIDE("PySide"),
    PYSIDE2("PySide2"),
    PYSIDE6("PySide6");

    PyQtBackend(@NlsSafe @NotNull String displayName) {
      myDisplayNameSupplier = () -> displayName;
    }

    PyQtBackend(Supplier<@Nls String> displayNamePointer) {
      myDisplayNameSupplier = displayNamePointer;
    }

    @Override
    public @Nls String toString() {
      return myDisplayNameSupplier.get();
    }

    private final Supplier<@Nls String> myDisplayNameSupplier;
  }

  private static final class PortRange {
    public static final int MIN = 0;
    public static final int MAX = 65535;
  }

  private final Project myProject;

  public PyDebuggerConfigurable(Project project) {
    myProject = project;
    {
      warningIcon = new JBLabel(AllIcons.General.BalloonWarning);
      IdeTooltipManager.getInstance().setCustomTooltip(
        warningIcon,
        new TooltipWithClickableLinks.ForBrowser(warningIcon,
                                                 PyBundle.message("debugger.warning.message")));

      myActionLink = new ActionLink(PyBundle.message("form.debugger.clear.caches.action"), e -> {
        boolean cleared = PySignatureCacheManager.getInstance(myProject).clearCache();
        String message;
        if (cleared) {
          message = PyBundle.message("python.debugger.collection.signatures.deleted");
        }
        else {
          message = PyBundle.message("python.debugger.nothing.to.delete");
        }
        Messages.showInfoMessage(myProject, message, PyBundle.message("debugger.delete.signature.cache"));
      });

      myRunDebuggerInServerMode = new JBCheckBox();
      myDebuggerPortPanel = new JPanel();
      myDebuggerPortLabel = new JBLabel(PyBundle.message("form.debugger.debugger.port"));
      myDebuggerPort = new JBIntSpinner(0, PortRange.MIN, PortRange.MAX);

      if (!Registry.is("python.debug.use.single.port")) {
        myRunDebuggerInServerMode.setVisible(false);
        myDebuggerPortPanel.setVisible(false);
        myDebuggerPortLabel.setVisible(false);
        myDebuggerPort.setVisible(false);
      }

      myDebuggerEvaluationResponseTimeoutLabel = new JBLabel(PyBundle.message("form.debugger.response.timeout"));
      myDebuggerEvaluationResponseTimeout = new JBIntSpinner(0, 0, Integer.MAX_VALUE, 500);
    }
    {
      // GUI initializer generated by IntelliJ IDEA GUI Designer
      // >>> IMPORTANT!! <<<
      // DO NOT EDIT OR ADD ANY CODE HERE!
      myMainPanel = new JPanel();
      myMainPanel.setLayout(new GridLayoutManager(4, 4, new Insets(0, 0, 0, 0), -1, -1));
      final JPanel panel1 = new JPanel();
      panel1.setLayout(new GridLayoutManager(7, 6, new Insets(0, 0, 0, 0), -1, -1));
      myMainPanel.add(panel1, new GridConstraints(0, 0, 1, 4, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_BOTH,
                                                  GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                  GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null, null,
                                                  null, 0, false));
      myAttachToSubprocess = new JCheckBox();
      this.$$$loadButtonText$$$(myAttachToSubprocess, this.$$$getMessageFromBundle$$$("messages/PyBundle",
                                                                                      "form.debugger.attach.to.subprocess.automatically.while.debugging"));
      panel1.add(myAttachToSubprocess, new GridConstraints(0, 0, 1, 5, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                           GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                           GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                           null, null, null, 0, false));
      mySaveSignatures = new JCheckBox();
      mySaveSignatures.setActionCommand(this.$$$getMessageFromBundle$$$("messages/PyBundle", "form.debugger.save.call.signatures"));
      mySaveSignatures.setLabel(
        this.$$$getMessageFromBundle$$$("messages/PyBundle", "form.debugger.collect.run.time.types.information.for.code.insight"));
      this.$$$loadButtonText$$$(mySaveSignatures, this.$$$getMessageFromBundle$$$("messages/PyBundle",
                                                                                  "form.debugger.collect.run.time.types.information.for.code.insight"));
      panel1.add(mySaveSignatures, new GridConstraints(1, 0, 1, 3, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                       GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                       GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null,
                                                       null, null, 0, false));
      mySupportGevent = new JCheckBox();
      this.$$$loadButtonText$$$(mySupportGevent, this.$$$getMessageFromBundle$$$("messages/PyBundle", "form.debugger.gevent.compatible"));
      panel1.add(mySupportGevent, new GridConstraints(2, 0, 1, 5, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                      GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                      GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null,
                                                      null, null, 0, false));
      mySupportQt = new JBCheckBox();
      this.$$$loadButtonText$$$(mySupportQt, this.$$$getMessageFromBundle$$$("messages/PyBundle", "form.debugger.pyqt.compatible"));
      panel1.add(mySupportQt, new GridConstraints(4, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                  GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                  GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null, null,
                                                  null, 0, false));
      panel1.add(warningIcon,
                 new GridConstraints(1, 3, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                     GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myPyQtBackend = new ComboBox();
      panel1.add(myPyQtBackend, new GridConstraints(4, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                    GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED, null, null, null,
                                                    0, false));
      final JBLabel jBLabel1 = new JBLabel();
      jBLabel1.setText("                                             ");
      panel1.add(jBLabel1,
                 new GridConstraints(4, 2, 1, 1, GridConstraints.ANCHOR_EAST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                     GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      this.$$$loadButtonText$$$(myActionLink, this.$$$getMessageFromBundle$$$("messages/PyBundle", "form.debugger.clear.caches"));
      panel1.add(myActionLink,
                 new GridConstraints(1, 4, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                     GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      final Spacer spacer1 = new Spacer();
      panel1.add(spacer1, new GridConstraints(1, 5, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                              GridConstraints.SIZEPOLICY_WANT_GROW, 1, null, new Dimension(75, 11), null, 0, false));
      myDropIntoDebuggerOnFailedTests = new JCheckBox();
      myDropIntoDebuggerOnFailedTests.setSelected(false);
      this.$$$loadButtonText$$$(myDropIntoDebuggerOnFailedTests,
                                this.$$$getMessageFromBundle$$$("messages/PyBundle", "form.debugger.drop.into.debugger.on.failed.tests"));
      panel1.add(myDropIntoDebuggerOnFailedTests, new GridConstraints(3, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                                      GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                      GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED,
                                                                      null, null, null, 0, false));
      myRunDebuggerInServerMode.setHorizontalAlignment(10);
      myRunDebuggerInServerMode.setSelected(true);
      this.$$$loadButtonText$$$(myRunDebuggerInServerMode,
                                this.$$$getMessageFromBundle$$$("messages/PyBundle", "form.debugger.run.debugger.in.server.mode"));
      panel1.add(myRunDebuggerInServerMode,
                 new GridConstraints(5, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                     GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myDebuggerPortPanel.setLayout(new GridLayoutManager(1, 2, new Insets(0, 0, 0, 0), -1, -1));
      panel1.add(myDebuggerPortPanel, new GridConstraints(6, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_BOTH,
                                                          GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                          GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null,
                                                          null, null, 1, false));
      this.$$$loadLabelText$$$(myDebuggerPortLabel, this.$$$getMessageFromBundle$$$("messages/PyBundle", "form.debugger.debugger.port"));
      myDebuggerPortPanel.add(myDebuggerPortLabel, new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                                       GridConstraints.SIZEPOLICY_FIXED, GridConstraints.SIZEPOLICY_FIXED,
                                                                       null, null, null, 0, false));
      myDebuggerPort.setMax(65535);
      myDebuggerPort.setMin(0);
      myDebuggerPortPanel.add(myDebuggerPort, new GridConstraints(0, 1, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_NONE,
                                                                  GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED,
                                                                  null, null, null, 0, false));
      final Spacer spacer2 = new Spacer();
      myMainPanel.add(spacer2, new GridConstraints(3, 1, 1, 3, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_VERTICAL, 1,
                                                   GridConstraints.SIZEPOLICY_WANT_GROW, null, null, null, 0, false));
      myAttachFilterLabel = new JBLabel();
      this.$$$loadLabelText$$$(myAttachFilterLabel, this.$$$getMessageFromBundle$$$("messages/PyBundle",
                                                                                    "form.debugger.for.attach.to.process.show.processes.with.names.containing"));
      myAttachFilterLabel.putClientProperty("html.disable", Boolean.FALSE);
      myMainPanel.add(myAttachFilterLabel, new GridConstraints(1, 0, 1, 2, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                               GridConstraints.SIZEPOLICY_FIXED, GridConstraints.SIZEPOLICY_FIXED, null,
                                                               null, null, 0, false));
      this.$$$loadLabelText$$$(myDebuggerEvaluationResponseTimeoutLabel,
                               this.$$$getMessageFromBundle$$$("messages/PyBundle", "form.debugger.response.timeout"));
      myDebuggerEvaluationResponseTimeoutLabel.putClientProperty("html.disable", Boolean.FALSE);
      myMainPanel.add(myDebuggerEvaluationResponseTimeoutLabel,
                      new GridConstraints(2, 0, 1, 2, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                          GridConstraints.SIZEPOLICY_FIXED, GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myAttachProcessFilter = new JBTextField();
      myAttachProcessFilter.setEnabled(true);
      myAttachProcessFilter.setText(
        this.$$$getMessageFromBundle$$$("messages/PyBundle", "form.debugger.remote.interpreter.docker.default.interpreter.path"));
      myMainPanel.add(myAttachProcessFilter, new GridConstraints(1, 2, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                                 GridConstraints.SIZEPOLICY_FIXED, GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                                                   GridConstraints.SIZEPOLICY_CAN_GROW,
                                                                 null, new Dimension(150, -1), null, 0, false));
      final Spacer spacer3 = new Spacer();
      myMainPanel.add(spacer3, new GridConstraints(1, 3, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                                   GridConstraints.SIZEPOLICY_CAN_GROW, 1, null, null, null, 0, false));
      myDebuggerEvaluationResponseTimeout.setMax(2147483647);
      myDebuggerEvaluationResponseTimeout.setMin(0);
      myMainPanel.add(myDebuggerEvaluationResponseTimeout,
                      new GridConstraints(2, 2, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                          GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0,
                                          false));
      myAttachFilterLabel.setLabelFor(myAttachProcessFilter);
      myDebuggerEvaluationResponseTimeoutLabel.setLabelFor(myAttachProcessFilter);
    }
    Arrays.stream(PyQtBackend.values()).forEach(e -> myPyQtBackend.addItem(e));

    mySupportQt.addItemListener(new ItemListener() {
      @Override
      public void itemStateChanged(ItemEvent e) {
        myPyQtBackend.setEnabled(mySupportQt.isSelected());
      }
    });

    myDebuggerPortPanel.setVisible(myRunDebuggerInServerMode.isSelected());
    myRunDebuggerInServerMode.addItemListener(new ItemListener() {
      @Override
      public void itemStateChanged(ItemEvent e) {
        myDebuggerPortPanel.setVisible(myRunDebuggerInServerMode.isSelected());
      }
    });

    myAttachFilterLabel.setText(PyBundle.message("debugger.attach.to.process.filter.names"));
  }

  private static Method $$$cachedGetBundleMethod$$$ = null;

  /** @noinspection ALL */
  private String $$$getMessageFromBundle$$$(String path, String key) {
    ResourceBundle bundle;
    try {
      Class<?> thisClass = this.getClass();
      if ($$$cachedGetBundleMethod$$$ == null) {
        Class<?> dynamicBundleClass = thisClass.getClassLoader().loadClass("com.intellij.DynamicBundle");
        $$$cachedGetBundleMethod$$$ = dynamicBundleClass.getMethod("getBundle", String.class, Class.class);
      }
      bundle = (ResourceBundle)$$$cachedGetBundleMethod$$$.invoke(null, path, thisClass);
    }
    catch (Exception e) {
      bundle = ResourceBundle.getBundle(path);
    }
    return bundle.getString(key);
  }

  /** @noinspection ALL */
  private void $$$loadLabelText$$$(JLabel component, String text) {
    StringBuffer result = new StringBuffer();
    boolean haveMnemonic = false;
    char mnemonic = '\0';
    int mnemonicIndex = -1;
    for (int i = 0; i < text.length(); i++) {
      if (text.charAt(i) == '&') {
        i++;
        if (i == text.length()) break;
        if (!haveMnemonic && text.charAt(i) != '&') {
          haveMnemonic = true;
          mnemonic = text.charAt(i);
          mnemonicIndex = result.length();
        }
      }
      result.append(text.charAt(i));
    }
    component.setText(result.toString());
    if (haveMnemonic) {
      component.setDisplayedMnemonic(mnemonic);
      component.setDisplayedMnemonicIndex(mnemonicIndex);
    }
  }

  /** @noinspection ALL */
  private void $$$loadButtonText$$$(AbstractButton component, String text) {
    StringBuffer result = new StringBuffer();
    boolean haveMnemonic = false;
    char mnemonic = '\0';
    int mnemonicIndex = -1;
    for (int i = 0; i < text.length(); i++) {
      if (text.charAt(i) == '&') {
        i++;
        if (i == text.length()) break;
        if (!haveMnemonic && text.charAt(i) != '&') {
          haveMnemonic = true;
          mnemonic = text.charAt(i);
          mnemonicIndex = result.length();
        }
      }
      result.append(text.charAt(i));
    }
    component.setText(result.toString());
    if (haveMnemonic) {
      component.setMnemonic(mnemonic);
      component.setDisplayedMnemonicIndex(mnemonicIndex);
    }
  }

  /** @noinspection ALL */
  public JComponent $$$getRootComponent$$$() { return myMainPanel; }

  @Override
  public String getDisplayName() {
    return PyBundle.message("configurable.PyDebuggerConfigurable.display.name");
  }

  @Override
  public String getHelpTopic() {
    return "reference.idesettings.debugger.python";
  }

  @Override
  public @NotNull String getId() {
    return getHelpTopic();
  }

  @Override
  public JComponent createComponent() {
    return myMainPanel;
  }

  @Override
  public boolean isModified() {
    PyDebuggerOptionsProvider settings = PyDebuggerOptionsProvider.getInstance(myProject);
    return myAttachToSubprocess.isSelected() != settings.isAttachToSubprocess() ||
           mySaveSignatures.isSelected() != settings.isSaveCallSignatures() ||
           mySupportGevent.isSelected() != settings.isSupportGeventDebugging() ||
           myDropIntoDebuggerOnFailedTests.isSelected() != settings.isDropIntoDebuggerOnFailedTest() ||
           mySupportQt.isSelected() != settings.isSupportQtDebugging() ||
           (myPyQtBackend.getSelectedItem() != null &&
            !StringUtil.toLowerCase((((PyQtBackend)myPyQtBackend.getSelectedItem()).name())).equals(settings.getPyQtBackend())) ||
           myRunDebuggerInServerMode.isSelected() != settings.isRunDebuggerInServerMode() ||
           myDebuggerPort.getNumber() != settings.getDebuggerPort() ||
           !myAttachProcessFilter.getText().equals(settings.getAttachProcessFilter()) ||
           myDebuggerEvaluationResponseTimeout.getNumber() != settings.getEvaluationResponseTimeout();
  }

  @Override
  public void apply() {
    PyDebuggerOptionsProvider settings = PyDebuggerOptionsProvider.getInstance(myProject);
    settings.setAttachToSubprocess(myAttachToSubprocess.isSelected());
    settings.setSaveCallSignatures(mySaveSignatures.isSelected());
    settings.setSupportGeventDebugging(mySupportGevent.isSelected());
    settings.setDropIntoDebuggerOnFailedTest(myDropIntoDebuggerOnFailedTests.isSelected());
    settings.setSupportQtDebugging(mySupportQt.isSelected());

    Object selectedBackend = myPyQtBackend.getSelectedItem();
    if (selectedBackend != null) {
      settings.setPyQtBackend(StringUtil.toLowerCase(((PyQtBackend)selectedBackend).name()));
    }

    settings.setRunDebuggerInServerMode(myRunDebuggerInServerMode.isSelected());
    settings.setDebuggerPort(myDebuggerPort.getNumber());

    settings.setAttachProcessFilter(myAttachProcessFilter.getText());
    settings.setEvaluationResponseTimeout(myDebuggerEvaluationResponseTimeout.getNumber());
  }

  @Override
  public void reset() {
    PyDebuggerOptionsProvider settings = PyDebuggerOptionsProvider.getInstance(myProject);
    myAttachToSubprocess.setSelected(settings.isAttachToSubprocess());
    mySaveSignatures.setSelected(settings.isSaveCallSignatures());
    mySupportGevent.setSelected(settings.isSupportGeventDebugging());
    myDropIntoDebuggerOnFailedTests.setSelected(settings.isDropIntoDebuggerOnFailedTest());
    mySupportQt.setSelected(settings.isSupportQtDebugging());
    myPyQtBackend.setSelectedItem(PyQtBackend.valueOf(StringUtil.toUpperCase(settings.getPyQtBackend())));
    myDebuggerPort.setNumber(settings.getDebuggerPort());
    myRunDebuggerInServerMode.setSelected(settings.isRunDebuggerInServerMode());
    myAttachProcessFilter.setText(settings.getAttachProcessFilter());
    myDebuggerEvaluationResponseTimeout.setNumber(settings.getEvaluationResponseTimeout());
  }
}
