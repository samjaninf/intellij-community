// Copyright 2000-2026 JetBrains s.r.o. and contributors. Use of this source code is governed by the Apache 2.0 license.

import {describe, it} from 'node:test'
import {ok, rejects} from 'node:assert/strict'
import {existsSync, mkdirSync, mkdtempSync, readFileSync, rmSync, writeFileSync} from 'node:fs'
import {tmpdir} from 'node:os'
import {join} from 'node:path'
import {renderSkills} from './render-guides.mjs'

const generatedSkillMarker = '<!-- Generated by community/.ai/render-guides.mjs'

function writeSkill(skillDir, name, body, generatedBySourcePath) {
  mkdirSync(skillDir, {recursive: true})
  const skillPath = join(skillDir, 'SKILL.md')
  let generatedHeader = ''
  if (generatedBySourcePath) {
    generatedHeader = `${generatedSkillMarker}; edit ${generatedBySourcePath} -->\n\n`
  }
  const content = `---
name: ${name}
description: ${name}
---
${generatedHeader}${body}
`
  writeFileSync(skillPath, content, 'utf8')
}

function createFixture() {
  const rootDir = mkdtempSync(join(tmpdir(), 'render-guides-test-'))

  const communitySourceDir = join(rootDir, 'community', '.agents', 'skills')
  const agentsDir = join(rootDir, '.agents', 'skills')
  const claudeDir = join(rootDir, '.claude', 'skills')
  const communityClaudeDir = join(rootDir, 'community', '.claude', 'skills')

  writeSkill(join(communitySourceDir, 'testing'), 'testing', '# Testing\n')
  writeSkill(join(agentsDir, 'platform-deep-dives'), 'platform-deep-dives', '# Platform Deep Dives\n')

  return {rootDir, communitySourceDir, agentsDir, claudeDir, communityClaudeDir}
}

describe('render-guides skills', () => {
  it('in ULTIMATE, emits ultimate-only stubs and cleans stale generated dirs', async () => {
    const {rootDir, communitySourceDir, agentsDir, claudeDir, communityClaudeDir} = createFixture()

    const staleAgentsDir = join(agentsDir, 'stale-generated-in-agents')
    const staleClaudeDir = join(claudeDir, 'stale-generated-in-claude')
    const staleCommunityClaudeDir = join(communityClaudeDir, 'stale-generated-in-community-claude')
    try {
      writeSkill(staleAgentsDir, 'stale-agents', 'stale\n', 'community/.agents/skills/testing/SKILL.md')
      writeSkill(staleClaudeDir, 'stale-claude', 'stale\n', 'community/.agents/skills/testing/SKILL.md')
      writeSkill(staleCommunityClaudeDir, 'stale-community-claude', 'stale\n', 'community/.agents/skills/testing/SKILL.md')

      ok(existsSync(staleAgentsDir))
      ok(existsSync(staleClaudeDir))
      ok(existsSync(staleCommunityClaudeDir))

      await renderSkills({
        communitySourceDir,
        agentsDir,
        claudeDir,
        communityClaudeDir,
        edition: 'ULTIMATE',
      })

      ok(!existsSync(staleAgentsDir), 'stale generated stub in .agents/skills was not removed')
      ok(!existsSync(staleClaudeDir), 'stale generated stub in .claude/skills was not removed')
      ok(!existsSync(staleCommunityClaudeDir), 'stale generated stub in community/.claude/skills was not removed')

      const ultimateSkillPath = join(agentsDir, 'platform-deep-dives', 'SKILL.md')
      const ultimateSkillContent = readFileSync(ultimateSkillPath, 'utf8')
      ok(!ultimateSkillContent.includes(generatedSkillMarker), 'ultimate source skill should not be generated')

      const claudeUltimateStubPath = join(claudeDir, 'platform-deep-dives', 'SKILL.md')
      ok(existsSync(claudeUltimateStubPath), 'ultimate-only stub is missing in .claude/skills')
      const claudeUltimateStubContent = readFileSync(claudeUltimateStubPath, 'utf8')
      ok(
        claudeUltimateStubContent.includes(generatedSkillMarker),
        'ultimate-only stub in .claude/skills does not point to the source skill',
      )

      const communityClaudeUltimateStubPath = join(communityClaudeDir, 'platform-deep-dives', 'SKILL.md')
      ok(!existsSync(communityClaudeUltimateStubPath), 'ultimate-only stub should not exist in community/.claude/skills')

      const agentsCommunityStubPath = join(agentsDir, 'testing', 'SKILL.md')
      ok(existsSync(agentsCommunityStubPath), 'community skill stub is missing in .agents/skills')

      const claudeCommunityStubPath = join(claudeDir, 'testing', 'SKILL.md')
      ok(existsSync(claudeCommunityStubPath), 'community skill stub is missing in .claude/skills')
      const claudeCommunityStubContent = readFileSync(claudeCommunityStubPath, 'utf8')
      ok(
        claudeCommunityStubContent.includes(generatedSkillMarker),
        'community skill stub in .claude/skills does not point to community source',
      )

      const communityClaudeTestingStubPath = join(communityClaudeDir, 'testing', 'SKILL.md')
      ok(existsSync(communityClaudeTestingStubPath), 'community skill stub is missing in community/.claude/skills')
    } finally {
      rmSync(rootDir, {recursive: true, force: true})
    }
  })

  it('in COMMUNITY, skips ultimate-only stubs and removes stale generated ultimate stubs', async () => {
    const {rootDir, communitySourceDir, agentsDir, claudeDir, communityClaudeDir} = createFixture()

    const staleUltimateStubDir = join(claudeDir, 'platform-deep-dives')
    try {
      writeSkill(staleUltimateStubDir, 'platform-deep-dives', 'stale\n', 'community/.agents/skills/testing/SKILL.md')
      ok(existsSync(staleUltimateStubDir), 'expected stale ultimate stub before render')

      await renderSkills({
        communitySourceDir,
        agentsDir,
        claudeDir,
        communityClaudeDir,
        edition: 'COMMUNITY',
      })

      ok(!existsSync(staleUltimateStubDir), 'community render should remove stale generated ultimate stub')

      const claudeUltimateStubPath = join(claudeDir, 'platform-deep-dives', 'SKILL.md')
      ok(!existsSync(claudeUltimateStubPath), 'community render should not emit ultimate-only stub')

      const agentsUltimateSourcePath = join(agentsDir, 'platform-deep-dives', 'SKILL.md')
      const agentsUltimateSourceContent = readFileSync(agentsUltimateSourcePath, 'utf8')
      ok(!agentsUltimateSourceContent.includes(generatedSkillMarker), 'ultimate source in .agents should stay manual')

      const agentsCommunityStubPath = join(agentsDir, 'testing', 'SKILL.md')
      ok(existsSync(agentsCommunityStubPath), 'community skill stub is missing in .agents/skills')

      const claudeCommunityStubPath = join(claudeDir, 'testing', 'SKILL.md')
      ok(existsSync(claudeCommunityStubPath), 'community skill stub is missing in .claude/skills')

      const communityClaudeTestingStubPath = join(communityClaudeDir, 'testing', 'SKILL.md')
      ok(existsSync(communityClaudeTestingStubPath), 'community skill stub is missing in community/.claude/skills')
    } finally {
      rmSync(rootDir, {recursive: true, force: true})
    }
  })

  it('fails fast when community and manual ultimate skill names collide', async () => {
    const {rootDir, communitySourceDir, agentsDir, claudeDir, communityClaudeDir} = createFixture()

    try {
      writeSkill(join(communitySourceDir, 'platform-deep-dives'), 'platform-deep-dives', '# Community Platform Deep Dives\n')

      await rejects(
        renderSkills({
          communitySourceDir,
          agentsDir,
          claudeDir,
          communityClaudeDir,
          edition: 'ULTIMATE',
        }),
        /Skill name collision for 'platform-deep-dives'/,
      )

      const agentsUltimateSourcePath = join(agentsDir, 'platform-deep-dives', 'SKILL.md')
      const agentsUltimateSourceContent = readFileSync(agentsUltimateSourcePath, 'utf8')
      ok(
        agentsUltimateSourceContent.includes('# Platform Deep Dives'),
        'manual ultimate source should remain unchanged after collision failure',
      )
    } finally {
      rmSync(rootDir, {recursive: true, force: true})
    }
  })

  it('fails fast when a community source skill has no YAML frontmatter', async () => {
    const {rootDir, communitySourceDir, agentsDir, claudeDir, communityClaudeDir} = createFixture()

    const staleGeneratedTestingDir = join(agentsDir, 'testing')
    try {
      writeSkill(staleGeneratedTestingDir, 'testing', 'stale\n', 'community/.agents/skills/testing/SKILL.md')
      writeFileSync(join(communitySourceDir, 'testing', 'SKILL.md'), '# Missing frontmatter\n', 'utf8')

      await rejects(
        renderSkills({
          communitySourceDir,
          agentsDir,
          claudeDir,
          communityClaudeDir,
          edition: 'COMMUNITY',
        }),
        /Invalid community skill source .*\/testing\/SKILL\.md: missing YAML frontmatter\./,
      )

      ok(existsSync(staleGeneratedTestingDir), 'render should fail before deleting stale generated stubs')
      const staleGeneratedTestingContent = readFileSync(join(staleGeneratedTestingDir, 'SKILL.md'), 'utf8')
      ok(staleGeneratedTestingContent.includes('stale'), 'existing generated stub should stay unchanged on failure')
    } finally {
      rmSync(rootDir, {recursive: true, force: true})
    }
  })

  it('fails fast when a manual ultimate source skill has no YAML frontmatter', async () => {
    const {rootDir, communitySourceDir, agentsDir, claudeDir, communityClaudeDir} = createFixture()

    try {
      writeFileSync(join(agentsDir, 'platform-deep-dives', 'SKILL.md'), '# Missing frontmatter\n', 'utf8')

      await rejects(
        renderSkills({
          communitySourceDir,
          agentsDir,
          claudeDir,
          communityClaudeDir,
          edition: 'ULTIMATE',
        }),
        /Invalid ultimate skill source .*\/platform-deep-dives\/SKILL\.md: missing YAML frontmatter\./,
      )
    } finally {
      rmSync(rootDir, {recursive: true, force: true})
    }
  })

  it('accepts CRLF frontmatter in community source skills', async () => {
    const {rootDir, communitySourceDir, agentsDir, claudeDir, communityClaudeDir} = createFixture()

    const crlfSkillDir = join(communitySourceDir, 'crlf-frontmatter')
    try {
      mkdirSync(crlfSkillDir, {recursive: true})
      writeFileSync(
        join(crlfSkillDir, 'SKILL.md'),
        '---\r\nname: crlf-frontmatter\r\ndescription: crlf-frontmatter\r\n---\r\n# CRLF Skill\r\n',
        'utf8',
      )

      await renderSkills({
        communitySourceDir,
        agentsDir,
        claudeDir,
        communityClaudeDir,
        edition: 'COMMUNITY',
      })

      const generatedStubPath = join(agentsDir, 'crlf-frontmatter', 'SKILL.md')
      ok(existsSync(generatedStubPath), 'community skill with CRLF frontmatter should generate a stub')
      const generatedStubContent = readFileSync(generatedStubPath, 'utf8')
      ok(
        generatedStubContent.startsWith('---\nname: crlf-frontmatter\ndescription: crlf-frontmatter\n---\n'),
        'generated frontmatter should be parsed and normalized',
      )
    } finally {
      rmSync(rootDir, {recursive: true, force: true})
    }
  })

  it('accepts BOM frontmatter with closing delimiter at EOF', async () => {
    const {rootDir, communitySourceDir, agentsDir, claudeDir, communityClaudeDir} = createFixture()

    const eofSkillDir = join(communitySourceDir, 'bom-eof-frontmatter')
    try {
      mkdirSync(eofSkillDir, {recursive: true})
      writeFileSync(
        join(eofSkillDir, 'SKILL.md'),
        '\uFEFF---\nname: bom-eof-frontmatter\ndescription: bom-eof-frontmatter\n---',
        'utf8',
      )

      await renderSkills({
        communitySourceDir,
        agentsDir,
        claudeDir,
        communityClaudeDir,
        edition: 'COMMUNITY',
      })

      const generatedStubPath = join(agentsDir, 'bom-eof-frontmatter', 'SKILL.md')
      ok(existsSync(generatedStubPath), 'community skill with BOM/EOF frontmatter should generate a stub')
      const generatedStubContent = readFileSync(generatedStubPath, 'utf8')
      ok(
        generatedStubContent.startsWith('---\nname: bom-eof-frontmatter\ndescription: bom-eof-frontmatter\n---\n'),
        'generated frontmatter should be parsed and normalized from BOM/EOF input',
      )
    } finally {
      rmSync(rootDir, {recursive: true, force: true})
    }
  })
})
